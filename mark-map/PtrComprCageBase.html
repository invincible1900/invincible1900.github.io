<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.25.0/themes/prism.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.2.0/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@6.7.0"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.2.7"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.2.0/dist/index.umd.min.js"></script><script>(r => {
                setTimeout(r);
              })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, data) => {
        const {
          Markmap
        } = getMarkmap();
        window.mm = Markmap.create('svg#mindmap', getOptions == null ? void 0 : getOptions(), data);
      })(() => window.markmap,null,{"t":"heading","d":1,"p":{"lines":[0,1]},"v":"PtrComprCageBase","c":[{"t":"heading","d":2,"p":{"lines":[1,2]},"v":"PtrComprCageBase","c":[{"t":"list_item","d":4,"p":{"lines":[2,3]},"v":"这个类主要功能就是保存一个 HeapObject 的 base 地址 ptr_"},{"t":"list_item","d":4,"p":{"lines":[3,4]},"v":"根据它的构造函数，这个地址可以直接给，也可以通过 Isolate::cage_base() 获取"},{"t":"list_item","d":4,"p":{"lines":[4,5]},"v":"直接给就是 <code>object.ptr_ &amp; 0xffffffff00000000</code>"},{"t":"list_item","d":4,"p":{"lines":[5,6]},"v":"通过 Isolate 就是 <code>*(Address *) ( ( (*(void **) ( (object.ptr_ &amp; 0xfffffffffffc0000) + 16) ) - 0xa2f8 ) + 0x38)</code>"},{"t":"list_item","d":4,"p":{"lines":[6,7]},"v":"具体怎么来的分别见 <code>GetPtrComprCageBase</code> 和 <code>GetIsolate</code>"},{"t":"list_item","d":4,"p":{"lines":[7,47]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/common/globals.h</span>\n<span class=\"token number\">1822</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PtrComprCageBase</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">1823</span>  <span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n<span class=\"token number\">1824</span>   <span class=\"token keyword\">explicit</span> <span class=\"token keyword\">constexpr</span> <span class=\"token function\">PtrComprCageBase</span><span class=\"token punctuation\">(</span>Address address<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token function\">address_</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token number\">1826</span>   <span class=\"token keyword\">inline</span> <span class=\"token function\">PtrComprCageBase</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> Isolate<span class=\"token operator\">*</span> isolate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">1828</span>   <span class=\"token keyword\">inline</span> <span class=\"token function\">PtrComprCageBase</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> LocalIsolate<span class=\"token operator\">*</span> isolate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">1829</span>\n<span class=\"token number\">1830</span>   <span class=\"token keyword\">inline</span> Address <span class=\"token function\">address</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">1831</span>\n<span class=\"token number\">1832</span>   <span class=\"token keyword\">bool</span> <span class=\"token keyword\">operator</span><span class=\"token operator\">==</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> PtrComprCageBase<span class=\"token operator\">&amp;</span> other<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">1833</span>     <span class=\"token keyword\">return</span> address_ <span class=\"token operator\">==</span> other<span class=\"token punctuation\">.</span>address_<span class=\"token punctuation\">;</span>\n<span class=\"token number\">1834</span>   <span class=\"token punctuation\">}</span>\n<span class=\"token number\">1835</span>\n<span class=\"token number\">1836</span>  <span class=\"token keyword\">private</span><span class=\"token operator\">:</span>\n<span class=\"token number\">1837</span>   Address address_<span class=\"token punctuation\">;</span> <span class=\"token comment\">// ptype PtrComprCageBase::address_: unsigned long</span>\n<span class=\"token number\">1838</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// src/common/ptr-compr-inl.h</span>\n<span class=\"token number\">18</span> <span class=\"token class-name\">PtrComprCageBase</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">PtrComprCageBase</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> Isolate<span class=\"token operator\">*</span> isolate<span class=\"token punctuation\">)</span>\n<span class=\"token number\">19</span>     <span class=\"token operator\">:</span> <span class=\"token function\">address_</span><span class=\"token punctuation\">(</span>isolate<span class=\"token operator\">-></span><span class=\"token function\">cage_base</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token number\">20</span> <span class=\"token class-name\">PtrComprCageBase</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">PtrComprCageBase</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> LocalIsolate<span class=\"token operator\">*</span> isolate<span class=\"token punctuation\">)</span>\n<span class=\"token number\">21</span>     <span class=\"token operator\">:</span> <span class=\"token function\">address_</span><span class=\"token punctuation\">(</span>isolate<span class=\"token operator\">-></span><span class=\"token function\">cage_base</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// PtrComprCageBase 的由来，Compr == Compression </span>\n<span class=\"token comment\">// [ptr-cage] Rename IsolateRoot to PtrComprCageBase</span>\n<span class=\"token comment\">// Currently, IsolateRoot is both the address of the Isolate root and the</span>\n<span class=\"token comment\">// base address of the pointer compression reservation. This CL teases the</span>\n<span class=\"token comment\">// two uses apart by renaming IsolateRoot to PtrComprCageBase.</span>\n\n<span class=\"token comment\">// - In addition to V8_COMPRESS_POINTERS, add a</span>\n<span class=\"token comment\">//   V8_COMPRESS_POINTERS_IN_ISOLATE_CAGE (vs SHARED_CAGE).</span>\n\n<span class=\"token comment\">// - Rename GetIsolate* helpers to GetPtrComprCageBase. When</span>\n<span class=\"token comment\">//   V8_COMPRESS_POINTERS_IN_ISOLATE_CAGE is true, the helpers remain as</span>\n<span class=\"token comment\">//   aliases to GetPtrComprCageBase.</span>\n\n<span class=\"token comment\">// - Rename kPtrComprIsolateRootAlignment to kPtrComprCageBaseAlignment.</span>\n</code></pre>\n"},{"t":"list_item","d":4,"p":{"lines":[47,48]},"v":"<code>PtrComprCageBase::PtrComprCageBase(const Isolate* isolate)</code>","c":[{"t":"list_item","d":6,"p":{"lines":[48,49]},"v":"<code>PtrComprCageBase( *(Address *)((void *)isolate + 0x38) )</code>"},{"t":"list_item","d":6,"p":{"lines":[49,73]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/common/ptr-compr-inl.h:19</span>\n<span class=\"token number\">18</span>  <span class=\"token class-name\">PtrComprCageBase</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">PtrComprCageBase</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> Isolate<span class=\"token operator\">*</span> isolate<span class=\"token punctuation\">)</span>\n<span class=\"token number\">19</span>      <span class=\"token operator\">:</span> <span class=\"token function\">address_</span><span class=\"token punctuation\">(</span>isolate<span class=\"token operator\">-></span><span class=\"token function\">cage_base</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// src/execution/isolate.h:1072</span>\n<span class=\"token number\">1072</span>      Address <span class=\"token function\">cage_base</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">1076</span>        <span class=\"token keyword\">return</span> <span class=\"token function\">isolate_data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">cage_base</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">1077</span>      <span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// isolate_data_ 的地址就是 isolate 地址</span>\n<span class=\"token comment\">// (gdb) p &amp;(((v8::internal::Isolate *)0) -> isolate_data_)</span>\n<span class=\"token comment\">// $39 = (v8::internal::IsolateData *) 0x0</span>\n\n<span class=\"token comment\">// cage_base_ 的偏移是 0x38</span>\n<span class=\"token comment\">// (gdb) p &amp;(((v8::internal::IsolateData *)0) -> cage_base_)</span>\n<span class=\"token comment\">// $40 = (v8::internal::Address *) 0x38</span>\n\n<span class=\"token comment\">// (gdb) p/x isolate->cage_base()</span>\n<span class=\"token comment\">// $47 = 0x25a800000000</span>\n<span class=\"token comment\">// (gdb) p/x *(Address *)((void *)isolate + 0x38)</span>\n<span class=\"token comment\">// $48 = 0x25a800000000</span>\n</code></pre>\n"}]}]},{"t":"heading","d":2,"p":{"lines":[73,74]},"v":"GetPtrComprCageBase()","c":[{"t":"list_item","d":4,"p":{"lines":[74,75]},"v":"取出 compression pointer 的 base 地址，即："},{"t":"list_item","d":4,"p":{"lines":[75,76]},"v":"<code>return object.ptr_ &amp; 0xffffffff00000000</code>"},{"t":"list_item","d":4,"p":{"lines":[76,84]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// GetPtrComprCageBase</span>\n<span class=\"token comment\">// src/common/ptr-compr-inl.h:102</span>\n<span class=\"token number\">101</span> <span class=\"token keyword\">inline</span> PtrComprCageBase <span class=\"token function\">GetPtrComprCageBase</span><span class=\"token punctuation\">(</span>HeapObject object<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">102</span>   <span class=\"token keyword\">return</span> <span class=\"token function\">GetPtrComprCageBaseFromOnHeapAddress</span><span class=\"token punctuation\">(</span>object<span class=\"token punctuation\">.</span><span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">103</span> <span class=\"token punctuation\">}</span>\n</code></pre>\n"},{"t":"list_item","d":4,"p":{"lines":[84,85]},"v":"Call stack","c":[{"t":"list_item","d":6,"p":{"lines":[85,86]},"v":"GetPtrComprCageBaseFromOnHeapAddress","c":[{"t":"list_item","d":8,"p":{"lines":[86,95]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// GetPtrComprCageBaseFromOnHeapAddress</span>\n<span class=\"token comment\">// src/common/ptr-compr-inl.h:45</span>\n<span class=\"token number\">44</span>  V8_INLINE <span class=\"token keyword\">constexpr</span> PtrComprCageBase <span class=\"token function\">GetPtrComprCageBaseFromOnHeapAddress</span><span class=\"token punctuation\">(</span>\n<span class=\"token number\">45</span>      Address address<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">46</span>    <span class=\"token keyword\">return</span> <span class=\"token function\">PtrComprCageBase</span><span class=\"token punctuation\">(</span><span class=\"token function\">GetPtrComprCageBaseAddress</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">47</span>  <span class=\"token punctuation\">}</span>\n</code></pre>\n"},{"t":"list_item","d":8,"p":{"lines":[95,96]},"v":"GetPtrComprCageBaseAddress","c":[{"t":"list_item","d":10,"p":{"lines":[96,106]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/common/ptr-compr-inl.h:36</span>\n<span class=\"token number\">36</span>  V8_INLINE <span class=\"token keyword\">constexpr</span> Address <span class=\"token function\">GetPtrComprCageBaseAddress</span><span class=\"token punctuation\">(</span>Address on_heap_addr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">37</span>    <span class=\"token keyword\">return</span> <span class=\"token generic-function\"><span class=\"token function\">RoundDown</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>kPtrComprCageBaseAlignment<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>on_heap_addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">38</span>  <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">(</span>gdb<span class=\"token punctuation\">)</span> p<span class=\"token operator\">/</span>x v8<span class=\"token double-colon punctuation\">::</span>internal<span class=\"token double-colon punctuation\">::</span>kPtrComprCageBaseAlignment\n$<span class=\"token number\">17</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x100000000</span>\n</code></pre>\n"},{"t":"list_item","d":10,"p":{"lines":[106,107]},"v":"RoundDown","c":[{"t":"list_item","d":12,"p":{"lines":[107,122]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\">#<span class=\"token number\">0</span>  <span class=\"token generic-function\"><span class=\"token function\">RoundDown</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token number\">4294967296l</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span><span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span>x<span class=\"token operator\">=</span><span class=\"token number\">52098087526681</span><span class=\"token punctuation\">)</span> at <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token operator\">/</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>src<span class=\"token operator\">/</span>base<span class=\"token operator\">/</span>macros<span class=\"token punctuation\">.</span>h<span class=\"token operator\">:</span><span class=\"token number\">331</span>\n<span class=\"token number\">331</span>   <span class=\"token keyword\">return</span> x <span class=\"token operator\">&amp;</span> <span class=\"token generic-function\"><span class=\"token function\">static_cast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// (gdb) disassemble</span>\n<span class=\"token comment\">// Dump of assembler code for function RoundDown&lt;4294967296l, unsigned long>(unsigned long):  // p/x 4294967296l: 0x100000000</span>\n<span class=\"token comment\">// => 0x00005555556545c0 &lt;+0>:  push   rbp</span>\n<span class=\"token comment\">//    0x00005555556545c1 &lt;+1>:  mov    rbp,rsp</span>\n<span class=\"token comment\">//    0x00005555556545c4 &lt;+4>:  mov    QWORD PTR [rbp-0x8],rdi  // i reg rdi: 0x2f6208002119, p/x on_heap_addr: 0x2f6208002119</span>\n<span class=\"token comment\">//    0x00005555556545c8 &lt;+8>:  movabs rax,0xffffffff00000000   // p/x -kPtrComprCageBaseAlignment:  0xffffffff00000000</span>\n<span class=\"token comment\">//    0x00005555556545d2 &lt;+18>: and    rax,QWORD PTR [rbp-0x8]</span>\n<span class=\"token comment\">//    0x00005555556545d6 &lt;+22>: pop    rbp</span>\n<span class=\"token comment\">//    0x00005555556545d7 &lt;+23>: ret</span>\n<span class=\"token comment\">// End of assembler dump.</span>\n</code></pre>\n"}]}]}]}]},{"t":"list_item","d":4,"p":{"lines":[122,123]},"v":"DEF_GETTER","c":[{"t":"list_item","d":6,"p":{"lines":[123,124]},"v":"GetPtrComprCageBase 在 DEF_GETTER 宏中有用到"},{"t":"list_item","d":6,"p":{"lines":[124,125]},"v":"宏定义","c":[{"t":"list_item","d":8,"p":{"lines":[125,135]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/objects/object-macros.h</span>\n<span class=\"token number\">83</span> #define <span class=\"token function\">DEF_GETTER</span><span class=\"token punctuation\">(</span>holder<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> type<span class=\"token punctuation\">)</span>                       \\\n<span class=\"token number\">84</span>   type holder<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>                                \\\n<span class=\"token number\">85</span>     PtrComprCageBase cage_base <span class=\"token operator\">=</span> <span class=\"token function\">GetPtrComprCageBase</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \\\n<span class=\"token number\">86</span>     <span class=\"token keyword\">return</span> holder<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span>cage_base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                          \\\n<span class=\"token number\">87</span>   <span class=\"token punctuation\">}</span>                                                          \\\n<span class=\"token number\">88</span>   type holder<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span>PtrComprCageBase cage_base<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span>\n</code></pre>\n"}]},{"t":"list_item","d":6,"p":{"lines":[135,136]},"v":"示例: DEF_GETTER(HeapObject, map, Map)","c":[{"t":"list_item","d":8,"p":{"lines":[136,155]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\">Map <span class=\"token class-name\">HeapObject</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>                                \\\n    PtrComprCageBase cage_base <span class=\"token operator\">=</span> <span class=\"token function\">GetPtrComprCageBase</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \\\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">HeapObject</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>cage_base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                          \\\n<span class=\"token punctuation\">}</span>                                                          \\\nMap <span class=\"token class-name\">HeapObject</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>PtrComprCageBase cage_base<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">map_word</span><span class=\"token punctuation\">(</span>cage_base<span class=\"token punctuation\">,</span> kRelaxedLoad<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// b ../../src/diagnostics/objects-printer.cc:290</span>\n<span class=\"token comment\">// (gdb) bt</span>\n<span class=\"token comment\">// #0 HeapObject::map (this=0x7fffffffb278) at ../../src/objects/objects-inl.h:713</span>\n<span class=\"token comment\">// #1 JSObject::PrintProperties (this=0x7fffffffb278, os=...) at ../../src/diagnostics/objects-printer.cc:290</span>\n<span class=\"token comment\">// (gdb) p/x cage_base</span>\n<span class=\"token comment\">// $19 = {address_ = 0x91100000000}</span>\n<span class=\"token comment\">// (gdb) p/x this->ptr_ &amp; 0xffffffff00000000</span>\n<span class=\"token comment\">// $21 = 0x91100000000</span>\n</code></pre>\n"}]},{"t":"list_item","d":6,"p":{"lines":[155,156]},"v":"示例: DEF_GETTER(Map, instance_descriptors, DescriptorArray)","c":[{"t":"list_item","d":8,"p":{"lines":[156,176]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\">DescriptorArray <span class=\"token class-name\">Map</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">instance_descriptors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n    PtrComprCageBase cage_base <span class=\"token operator\">=</span> <span class=\"token function\">GetPtrComprCageBase</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">Map</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">instance_descriptors</span><span class=\"token punctuation\">(</span>cage_base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\nDescriptorArray <span class=\"token class-name\">Map</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">instance_descriptors</span><span class=\"token punctuation\">(</span>PtrComprCageBase cage_base<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n    DescriptorArray value <span class=\"token operator\">=</span>\n        <span class=\"token class-name\">TaggedField</span><span class=\"token operator\">&lt;</span>DescriptorArray<span class=\"token punctuation\">,</span> kInstanqceDescriptorsOffset<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>cage_base<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> value<span class=\"token punctuation\">;</span>   \n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// b ../../src/diagnostics/objects-printer.cc:290</span>\n<span class=\"token comment\">// (gdb) p/x *(Address *) ( ( (*(void **) ( (this->ptr_ &amp; 0xfffffffffffc0000) + 16) ) - 0xa2f8 ) + 0x38)</span>\n<span class=\"token comment\">// $53 = 0x25a800000000</span>\n<span class=\"token comment\">// (gdb) p/x cage_base</span>\n<span class=\"token comment\">// $54 = {address_ = 0x25a800000000}</span>\n<span class=\"token comment\">// (gdb) p/x this->ptr_ &amp; 0xffffffff00000000</span>\n<span class=\"token comment\">// $55 = 0x25a800000000</span>\n</code></pre>\n"}]}]}]},{"t":"heading","d":2,"p":{"lines":[176,177]},"v":"GetIsolate","c":[{"t":"list_item","d":4,"p":{"lines":[177,178]},"v":"<code>return (Isolate*)( (*(void **) ( (this-&gt;ptr_ &amp; 0xfffffffffffc0000) + 16) ) - 0xa2f8 )</code>"},{"t":"list_item","d":4,"p":{"lines":[178,205]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// GetIsolate</span>\n<span class=\"token comment\">// src/objects/js-objects-inl.h:47</span>\n<span class=\"token number\">42</span>   Isolate<span class=\"token operator\">*</span> <span class=\"token class-name\">JSReceiver</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetIsolate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>                                      \\\n<span class=\"token number\">43</span>     <span class=\"token keyword\">return</span> <span class=\"token function\">GetIsolateFromWritableObject</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                            \\\n<span class=\"token number\">44</span>   <span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 宏定义</span>\n<span class=\"token comment\">// 47 NEVER_READ_ONLY_SPACE_IMPL(JSReceiver)</span>\n<span class=\"token comment\">// 40 #define NEVER_READ_ONLY_SPACE_IMPL(Type)                                   \\\n// 41   Heap* Type::GetHeap() const { return GetHeapFromWritableObject(*this); } \\\n// 42   Isolate* Type::GetIsolate() const {                                      \\\n// 43     return GetIsolateFromWritableObject(*this);                            \\\n// 44   }</span>\n\n<span class=\"token comment\">// Debug demo: </span>\n<span class=\"token comment\">// (gdb) bt</span>\n<span class=\"token comment\">// #0 JSReceiver::GetIsolate (this=0x7fffffffb278) at ../../src/objects/js-objects-inl.h:47</span>\n<span class=\"token comment\">// #1 JSObject::PrintProperties (this=0x7fffffffb278, os=...) at ../../src/diagnostics/objects-printer.cc:290</span>\n\n<span class=\"token comment\">// (gdb) p (Isolate*)( (*(void **) ( (this->ptr_ &amp; 0xfffffffffffc0000) + 16) ) - 0xa2f8 )</span>\n<span class=\"token comment\">// $37 = (v8::internal::Isolate *) 0x5555556b0660</span>\n<span class=\"token comment\">// (gdb) frame 1</span>\n<span class=\"token comment\">// (gdb) p GetIsolate()</span>\n<span class=\"token comment\">// $38 = (v8::internal::Isolate *) 0x5555556b0660    </span>\n</code></pre>\n"},{"t":"list_item","d":4,"p":{"lines":[205,206]},"v":"call stack","c":[{"t":"list_item","d":6,"p":{"lines":[206,207]},"v":"GetIsolateFromWritableObject()","c":[{"t":"list_item","d":8,"p":{"lines":[207,219]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// GetIsolateFromWritableObject</span>\n<span class=\"token comment\">// src/execution/isolate-utils-inl.h:57</span>\n<span class=\"token number\">57</span> V8_INLINE Isolate<span class=\"token operator\">*</span> <span class=\"token function\">GetIsolateFromWritableObject</span><span class=\"token punctuation\">(</span>HeapObject object<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">66</span>   <span class=\"token keyword\">return</span> <span class=\"token class-name\">Isolate</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">FromHeap</span><span class=\"token punctuation\">(</span><span class=\"token function\">GetHeapFromWritableObject</span><span class=\"token punctuation\">(</span>object<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">68</span> <span class=\"token punctuation\">}</span>\n\n\n</code></pre>\n"},{"t":"list_item","d":8,"p":{"lines":[219,220]},"v":"GetHeapFromWritableObject()","c":[{"t":"list_item","d":10,"p":{"lines":[220,221]},"v":"<code>return (Heap*)(*(void **)((object.ptr_ &amp; 0xfffffffffffc0000) + 16))</code>"},{"t":"list_item","d":10,"p":{"lines":[221,255]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// GetHeapFromWritableObject</span>\n<span class=\"token comment\">// src/execution/isolate-utils-inl.h:39</span>\n<span class=\"token number\">39</span> V8_INLINE Heap<span class=\"token operator\">*</span> <span class=\"token function\">GetHeapFromWritableObject</span><span class=\"token punctuation\">(</span>HeapObject object<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">51</span>   heap_internals<span class=\"token double-colon punctuation\">::</span>MemoryChunk<span class=\"token operator\">*</span> chunk <span class=\"token operator\">=</span>\n<span class=\"token number\">52</span>       heap_internals<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">MemoryChunk</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">FromHeapObject</span><span class=\"token punctuation\">(</span>object<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">53</span>   <span class=\"token keyword\">return</span> chunk<span class=\"token operator\">-></span><span class=\"token function\">GetHeap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">55</span> <span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Debug demo: </span>\n<span class=\"token comment\">// b ../../src/diagnostics/objects-printer.cc:290</span>\n<span class=\"token comment\">// (gdb) bt</span>\n<span class=\"token comment\">// #0 GetIsolateFromWritableObject (object=...) at ../../src/execution/isolate-utils-inl.h:66</span>\n<span class=\"token comment\">// #1 JSReceiver::GetIsolate (this=0x7fffffffb278) at ../../src/objects/js-objects-inl.h:47</span>\n<span class=\"token comment\">// #2 JSObject::PrintProperties (this=0x7fffffffb278, os=...) at ../../src/diagnostics/objects-printer.cc:290</span>\n\n<span class=\"token comment\">// Dump of assembler code for function GetIsolateFromWritableObject(HeapObject):</span>\n<span class=\"token comment\">// 0x0000555555678db8 &lt;+24>:    call   0x55555565d240 &lt;GetHeapFromWritableObject(HeapObject)></span>\n<span class=\"token comment\">// 0x0000555555678dbd &lt;+29>:    mov    rdi,rax</span>\n<span class=\"token comment\">// => 0x0000555555678dc0 &lt;+32>: call   0x55555565d360 &lt;Isolate::FromHeap(Heap*)></span>\n<span class=\"token comment\">// 0x0000555555678dc5 &lt;+37>:    add    rsp,0x10</span>\n<span class=\"token comment\">// 0x0000555555678dc9 &lt;+41>:    pop    rbp</span>\n<span class=\"token comment\">// 0x0000555555678dca &lt;+42>:    ret</span>\n\n<span class=\"token comment\">// (gdb) p *(void **)((object.ptr_ &amp; 0xfffffffffffc0000) + 16)</span>\n<span class=\"token comment\">// $34 = (void *) 0x5555556ba958</span>\n<span class=\"token comment\">// (gdb) i reg rax</span>\n<span class=\"token comment\">// rax            0x5555556ba958      </span>\n<span class=\"token comment\">// (gdb) x/1xg (object.ptr() &amp; ~v8::internal::kPageAlignmentMask + heap_internals::MemoryChunk::kHeapOffset)</span>\n<span class=\"token comment\">// 0x25a808100010:  0x00005555556ba958  </span>\n\n</code></pre>\n"},{"t":"list_item","d":10,"p":{"lines":[255,256]},"v":"MemoryChunk::FromHeapObject()","c":[{"t":"list_item","d":12,"p":{"lines":[256,268]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// MemoryChunk::FromHeapObject </span>\n<span class=\"token comment\">// src/heap/heap-write-barrier-inl.h:53</span>\n<span class=\"token number\">52</span>    V8_INLINE <span class=\"token keyword\">static</span> heap_internals<span class=\"token double-colon punctuation\">::</span>MemoryChunk<span class=\"token operator\">*</span> <span class=\"token function\">FromHeapObject</span><span class=\"token punctuation\">(</span>\n<span class=\"token number\">53</span>        HeapObject object<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">55</span>      <span class=\"token keyword\">return</span> <span class=\"token generic-function\"><span class=\"token function\">reinterpret_cast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>MemoryChunk<span class=\"token operator\">*</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>object<span class=\"token punctuation\">.</span><span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token operator\">~</span>kPageAlignmentMask<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">56</span>    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">(</span>gdb<span class=\"token punctuation\">)</span> p<span class=\"token operator\">/</span>x <span class=\"token operator\">~</span>v8<span class=\"token double-colon punctuation\">::</span>internal<span class=\"token double-colon punctuation\">::</span>kPageAlignmentMask\n$<span class=\"token number\">31</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xfffffffffffc0000</span>\n</code></pre>\n"}]},{"t":"list_item","d":10,"p":{"lines":[268,269]},"v":"MemoryChunk::GetHeap()","c":[{"t":"list_item","d":12,"p":{"lines":[269,282]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// MemoryChunk::GetHeap</span>\n<span class=\"token comment\">// src/heap/heap-write-barrier-inl.h:71</span>\n<span class=\"token number\">71</span>    V8_INLINE Heap<span class=\"token operator\">*</span> <span class=\"token function\">GetHeap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">72</span>      Heap<span class=\"token operator\">*</span> heap <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token generic-function\"><span class=\"token function\">reinterpret_cast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Heap<span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token generic-function\"><span class=\"token function\">reinterpret_cast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Address<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span>\n<span class=\"token number\">73</span>                                             kHeapOffset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">75</span>      <span class=\"token keyword\">return</span> heap<span class=\"token punctuation\">;</span>\n<span class=\"token number\">76</span>    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">(</span>gdb<span class=\"token punctuation\">)</span> p heap_internals<span class=\"token double-colon punctuation\">::</span>MemoryChunk<span class=\"token double-colon punctuation\">::</span>kHeapOffset\n$<span class=\"token number\">28</span> <span class=\"token operator\">=</span> <span class=\"token number\">16</span>\n</code></pre>\n"}]}]},{"t":"list_item","d":8,"p":{"lines":[282,283]},"v":"Isolate::FromHeap()","c":[{"t":"list_item","d":10,"p":{"lines":[283,284]},"v":"通过 Isolate::heap_ 获取 Isolate 地址"},{"t":"list_item","d":10,"p":{"lines":[284,285]},"v":"<code>return (Isolate*)((void *)heap - 0xa2f8)</code>"},{"t":"list_item","d":10,"p":{"lines":[285,306]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/execution/isolate.h:1061</span>\n<span class=\"token number\">1061</span>      <span class=\"token keyword\">static</span> Isolate<span class=\"token operator\">*</span> <span class=\"token function\">FromHeap</span><span class=\"token punctuation\">(</span>Heap<span class=\"token operator\">*</span> heap<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">1062</span>        <span class=\"token keyword\">return</span> <span class=\"token generic-function\"><span class=\"token function\">reinterpret_cast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Isolate<span class=\"token operator\">*</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token generic-function\"><span class=\"token function\">reinterpret_cast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Address<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>heap<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span>\n<span class=\"token number\">1063</span>                                          <span class=\"token function\">OFFSET_OF</span><span class=\"token punctuation\">(</span>Isolate<span class=\"token punctuation\">,</span> heap_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">1064</span>      <span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// (gdb) disassemble</span>\n<span class=\"token comment\">// Dump of assembler code for function Isolate::FromHeap(Heap*):</span>\n<span class=\"token comment\">// => 0x000055555565d360 &lt;+0>:  push   rbp</span>\n<span class=\"token comment\">//    0x000055555565d361 &lt;+1>:  mov    rbp,rsp</span>\n<span class=\"token comment\">//    0x000055555565d364 &lt;+4>:  mov    QWORD PTR [rbp-0x8],rdi  </span>\n<span class=\"token comment\">//    0x000055555565d368 &lt;+8>:  mov    rax,QWORD PTR [rbp-0x8]</span>\n<span class=\"token comment\">//    0x000055555565d36c &lt;+12>: mov    ecx,0x10</span>\n<span class=\"token comment\">//    0x000055555565d371 &lt;+17>: add    rcx,0xa2f8  // p &amp;(((v8::internal::Isolate *)0)->heap_) : 0xa2f8</span>\n<span class=\"token comment\">//    0x000055555565d378 &lt;+24>: sub    rcx,0x10</span>\n<span class=\"token comment\">//    0x000055555565d37c &lt;+28>: sub    rax,rcx     // i reg rax: 0x5555556ba958; p heap : 0x5555556ba958</span>\n<span class=\"token comment\">//    0x000055555565d37f &lt;+31>: pop    rbp</span>\n<span class=\"token comment\">//    0x000055555565d380 &lt;+32>: ret</span>\n<span class=\"token comment\">// End of assembler dump.</span>\n</code></pre>\n"}]}]}]}]}]})</script>
</body>
</html>
