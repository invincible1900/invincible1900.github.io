<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.25.0/themes/prism.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.2.0/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@6.7.0"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.2.7"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.2.0/dist/index.umd.min.js"></script><script>(r => {
                setTimeout(r);
              })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, data) => {
        const {
          Markmap
        } = getMarkmap();
        window.mm = Markmap.create('svg#mindmap', getOptions == null ? void 0 : getOptions(), data);
      })(() => window.markmap,null,{"t":"heading","d":1,"p":{"lines":[0,1]},"v":"ObjectData","c":[{"t":"bullet_list","d":2,"p":{"lines":[1,26]},"v":"","c":[{"t":"list_item","d":3,"p":{"lines":[1,2]},"v":"The Big Map","c":[{"t":"list_item","d":5,"p":{"lines":[2,3]},"v":"<code>class ObjectData</code>","c":[{"t":"list_item","d":7,"p":{"lines":[3,4]},"v":"Handle&lt;Object&gt; const object_;"},{"t":"list_item","d":7,"p":{"lines":[4,5]},"v":"ObjectDataKind const kind_;"},{"t":"list_item","d":7,"p":{"lines":[5,6]},"v":"ObjectData::IsXXX()"},{"t":"list_item","d":7,"p":{"lines":[6,7]},"v":"ObjectData::AsXXX()"},{"t":"list_item","d":7,"p":{"lines":[7,8]},"v":"class HeapObjectData : public ObjectData","c":[{"t":"list_item","d":9,"p":{"lines":[8,9]},"v":"class MapData : public HeapObjectData","c":[{"t":"list_item","d":11,"p":{"lines":[9,10]},"v":"MapData::instance_type_"},{"t":"list_item","d":11,"p":{"lines":[10,11]},"v":"MapData::instance_size_"},{"t":"list_item","d":11,"p":{"lines":[11,12]},"v":"MapData::bit_field3_"},{"t":"list_item","d":11,"p":{"lines":[12,13]},"v":"..."}]},{"t":"list_item","d":9,"p":{"lines":[13,14]},"v":"class PropertyCellData : public HeapObjectData","c":[{"t":"list_item","d":11,"p":{"lines":[14,15]},"v":"PropertyDetails property_details_"},{"t":"list_item","d":11,"p":{"lines":[15,16]},"v":"ObjectData *value_"}]},{"t":"list_item","d":9,"p":{"lines":[16,17]},"v":"..."}]}]},{"t":"list_item","d":5,"p":{"lines":[17,18]},"v":"<code>class ObjectRef</code>","c":[{"t":"list_item","d":7,"p":{"lines":[18,19]},"v":"ObjectData * ObjectRef::data_"},{"t":"list_item","d":7,"p":{"lines":[19,20]},"v":"JSHeapBroker * ObjectRef::broker_"},{"t":"list_item","d":7,"p":{"lines":[20,21]},"v":"class HeapObjectRef","c":[{"t":"list_item","d":9,"p":{"lines":[21,22]},"v":"class MapRef"},{"t":"list_item","d":9,"p":{"lines":[22,23]},"v":"class PropertyCellRef"},{"t":"list_item","d":9,"p":{"lines":[23,24]},"v":"..."}]}]},{"t":"list_item","d":5,"p":{"lines":[24,25]},"v":"<code>class HandleBase</code>","c":[{"t":"list_item","d":7,"p":{"lines":[25,26]},"v":"<code>class Handle&lt;T&gt;</code>"}]}]}]},{"t":"heading","d":2,"p":{"lines":[26,27]},"v":"class ObjectData","c":[{"t":"list_item","d":4,"p":{"lines":[27,28]},"v":"保存了 <code>Handle&lt;Object&gt; const object_;</code>  和 <code>ObjectDataKind const kind_;</code>"},{"t":"list_item","d":4,"p":{"lines":[28,29]},"v":"提供一系列 IsXXX 和 AsXXX 方法，判断 this 指向的数据类型，执行指针的cast"},{"t":"list_item","d":4,"p":{"lines":[29,56]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/compiler/heap-refs.cc</span>\n<span class=\"token number\">86</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ObjectData</span> <span class=\"token operator\">:</span> <span class=\"token base-clause\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">ZoneObject</span></span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">87</span>  <span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n<span class=\"token number\">88</span>   <span class=\"token function\">ObjectData</span><span class=\"token punctuation\">(</span>JSHeapBroker<span class=\"token operator\">*</span> broker<span class=\"token punctuation\">,</span> ObjectData<span class=\"token operator\">*</span><span class=\"token operator\">*</span> storage<span class=\"token punctuation\">,</span> Handle<span class=\"token operator\">&lt;</span>Object<span class=\"token operator\">></span> object<span class=\"token punctuation\">,</span>\n<span class=\"token number\">89</span>              ObjectDataKind kind<span class=\"token punctuation\">)</span>\n<span class=\"token number\">90</span>       <span class=\"token operator\">:</span> <span class=\"token function\">object_</span><span class=\"token punctuation\">(</span>object<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token number\">91</span>         <span class=\"token function\">kind_</span><span class=\"token punctuation\">(</span>kind<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">96</span>   <span class=\"token punctuation\">{</span>\n<span class=\"token number\">97</span>     <span class=\"token comment\">// This assignment ensures we don't end up inserting the same object</span>\n<span class=\"token number\">98</span>     <span class=\"token comment\">// in an endless recursion.</span>\n<span class=\"token number\">99</span>     <span class=\"token operator\">*</span>storage <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">122</span>   <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">124</span> #define <span class=\"token function\">DECLARE_IS</span><span class=\"token punctuation\">(</span>Name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">bool</span> Is##<span class=\"token function\">Name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">128</span> #define <span class=\"token function\">DECLARE_AS</span><span class=\"token punctuation\">(</span>Name<span class=\"token punctuation\">)</span> Name##Data<span class=\"token operator\">*</span> As##<span class=\"token function\">Name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">146</span>  <span class=\"token keyword\">private</span><span class=\"token operator\">:</span>\n<span class=\"token number\">147</span>   Handle<span class=\"token operator\">&lt;</span>Object<span class=\"token operator\">></span> <span class=\"token keyword\">const</span> object_<span class=\"token punctuation\">;</span>\n<span class=\"token number\">148</span>   ObjectDataKind <span class=\"token keyword\">const</span> kind_<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">152</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre>\n"},{"t":"list_item","d":4,"p":{"lines":[56,57]},"v":"ObjectDataKind","c":[{"t":"list_item","d":6,"p":{"lines":[57,106]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/compiler/heap-refs.cc</span>\n<span class=\"token number\">34</span> <span class=\"token comment\">// There are several kinds of ObjectData values.</span>\n<span class=\"token number\">35</span> <span class=\"token comment\">//</span>\n<span class=\"token number\">36</span> <span class=\"token comment\">// kSmi: The underlying V8 object is a Smi and the data is an instance of the</span>\n<span class=\"token number\">37</span> <span class=\"token comment\">//   base class (ObjectData), i.e. it's basically just the handle.  Because the</span>\n<span class=\"token number\">38</span> <span class=\"token comment\">//   object is a Smi, it's safe to access the handle in order to extract the</span>\n<span class=\"token number\">39</span> <span class=\"token comment\">//   number value, and AsSmi() does exactly that.</span>\n<span class=\"token number\">40</span> <span class=\"token comment\">//</span>\n<span class=\"token number\">41</span> <span class=\"token comment\">// kBackgroundSerializedHeapObject: The underlying V8 object is a HeapObject</span>\n<span class=\"token number\">42</span> <span class=\"token comment\">//   and the data is an instance of the corresponding (most-specific) subclass,</span>\n<span class=\"token number\">43</span> <span class=\"token comment\">//   e.g. JSFunctionData, which provides serialized information about the</span>\n<span class=\"token number\">44</span> <span class=\"token comment\">//   object. Allows serialization from the background thread.</span>\n<span class=\"token number\">45</span> <span class=\"token comment\">//</span>\n<span class=\"token number\">46</span> <span class=\"token comment\">// kUnserializedHeapObject: The underlying V8 object is a HeapObject and the</span>\n<span class=\"token number\">47</span> <span class=\"token comment\">//   data is an instance of the base class (ObjectData), i.e. it basically</span>\n<span class=\"token number\">48</span> <span class=\"token comment\">//   carries no information other than the handle.</span>\n<span class=\"token number\">49</span> <span class=\"token comment\">//</span>\n<span class=\"token number\">50</span> <span class=\"token comment\">// kNeverSerializedHeapObject: The underlying V8 object is a (potentially</span>\n<span class=\"token number\">51</span> <span class=\"token comment\">//   mutable) HeapObject and the data is an instance of ObjectData. Its handle</span>\n<span class=\"token number\">52</span> <span class=\"token comment\">//   must be persistent so that the GC can update it at a safepoint. Via this</span>\n<span class=\"token number\">53</span> <span class=\"token comment\">//   handle, the object can be accessed concurrently to the main thread. To be</span>\n<span class=\"token number\">54</span> <span class=\"token comment\">//   used the flag --concurrent-inlining must be on.</span>\n<span class=\"token number\">55</span> <span class=\"token comment\">//</span>\n<span class=\"token number\">56</span> <span class=\"token comment\">// kUnserializedReadOnlyHeapObject: The underlying V8 object is a read-only</span>\n<span class=\"token number\">57</span> <span class=\"token comment\">//   HeapObject and the data is an instance of ObjectData. For</span>\n<span class=\"token number\">58</span> <span class=\"token comment\">//   ReadOnlyHeapObjects, it is OK to access heap even from off-thread, so</span>\n<span class=\"token number\">59</span> <span class=\"token comment\">//   these objects need not be serialized.</span>\n\n<span class=\"token comment\">// serialize 表示内存区域转换成对象 (serialization)</span>\n<span class=\"token number\">60</span> <span class=\"token keyword\">enum</span> <span class=\"token class-name\">ObjectDataKind</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">61</span>   kSmi<span class=\"token punctuation\">,</span>\n<span class=\"token number\">62</span>   kBackgroundSerializedHeapObject<span class=\"token punctuation\">,</span>\n<span class=\"token number\">63</span>   kUnserializedHeapObject<span class=\"token punctuation\">,</span>\n<span class=\"token number\">64</span>   kNeverSerializedHeapObject<span class=\"token punctuation\">,</span>\n<span class=\"token number\">65</span>   kUnserializedReadOnlyHeapObject\n<span class=\"token number\">66</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre>\n","c":[{"t":"list_item","d":8,"p":{"lines":[96,97]},"v":"ObjectData::should_access_heap()","c":[{"t":"list_item","d":10,"p":{"lines":[97,106]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">135</span>   <span class=\"token keyword\">bool</span> <span class=\"token function\">should_access_heap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">136</span>     <span class=\"token keyword\">return</span> kind_ <span class=\"token operator\">==</span> kUnserializedHeapObject <span class=\"token operator\">||</span>\n<span class=\"token number\">137</span>            kind_ <span class=\"token operator\">==</span> kNeverSerializedHeapObject <span class=\"token operator\">||</span>\n<span class=\"token number\">138</span>            kind_ <span class=\"token operator\">==</span> kUnserializedReadOnlyHeapObject<span class=\"token punctuation\">;</span>\n<span class=\"token number\">139</span>   <span class=\"token punctuation\">}</span>\n</code></pre>\n"}]}]}]},{"t":"list_item","d":4,"p":{"lines":[106,107]},"v":"ObjectData::IsPropertyCell","c":[{"t":"list_item","d":6,"p":{"lines":[107,134]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/compiler/heap-refs.cc</span>\n<span class=\"token number\">1155</span>   <span class=\"token keyword\">bool</span> <span class=\"token class-name\">ObjectData</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">IsPropertyCell</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>                                   \\\n<span class=\"token number\">1156</span>     <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">should_access_heap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>                                         \\\n<span class=\"token number\">1157</span>       <span class=\"token keyword\">return</span> <span class=\"token function\">object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">IsPropertyCell</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                                      \\\n<span class=\"token number\">1158</span>     <span class=\"token punctuation\">}</span>                                                                   \\\n<span class=\"token number\">1159</span>     <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">is_smi</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>                                         \\\n<span class=\"token number\">1160</span>     InstanceType instance_type <span class=\"token operator\">=</span>                                        \\\n<span class=\"token number\">1161</span>         <span class=\"token generic-function\"><span class=\"token function\">static_cast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> HeapObjectData<span class=\"token operator\">*</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetMapInstanceType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \\\n<span class=\"token number\">1162</span>     <span class=\"token keyword\">return</span> <span class=\"token class-name\">InstanceTypeChecker</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">IsPropertyCell</span><span class=\"token punctuation\">(</span>instance_type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                \\\n<span class=\"token number\">1163</span>   <span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 宏定义</span>\n<span class=\"token comment\">// 1154 #define DEFINE_IS(Name)                                                 \\\n// 1155   bool ObjectData::Is##Name() const {                                   \\\n// 1156     if (should_access_heap()) {                                         \\\n// 1157       return object()->Is##Name();                                      \\\n// 1158     }                                                                   \\\n// 1159     if (is_smi()) return false;                                         \\\n// 1160     InstanceType instance_type =                                        \\\n// 1161         static_cast&lt;const HeapObjectData*>(this)->GetMapInstanceType(); \\\n// 1162     return InstanceTypeChecker::Is##Name(instance_type);                \\\n// 1163   }</span>\n<span class=\"token comment\">// 1164 HEAP_BROKER_OBJECT_LIST(DEFINE_IS)</span>\n<span class=\"token comment\">// 1165 #undef DEFINE_IS</span>\n</code></pre>\n"}]},{"t":"list_item","d":4,"p":{"lines":[134,135]},"v":"ObjectData::AsMap","c":[{"t":"list_item","d":6,"p":{"lines":[135,150]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">1168</span>   MapData<span class=\"token operator\">*</span> <span class=\"token class-name\">ObjectData</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">AsMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>               \\\n<span class=\"token number\">1171</span>     <span class=\"token keyword\">return</span> <span class=\"token generic-function\"><span class=\"token function\">static_cast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>MapData<span class=\"token operator\">*</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>           \\\n<span class=\"token number\">1172</span>   <span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 1167 #define DEFINE_AS(Name)                              \\\n// 1168   Name##Data* ObjectData::As##Name() {               \\\n// 1169     CHECK(Is##Name());                               \\\n// 1170     CHECK(kind_ == kBackgroundSerializedHeapObject); \\\n// 1171     return static_cast&lt;Name##Data*>(this);           \\\n// 1172   }</span>\n<span class=\"token comment\">// 1173 HEAP_BROKER_BACKGROUND_SERIALIZED_OBJECT_LIST(DEFINE_AS)</span>\n<span class=\"token comment\">// 1174 #undef DEFINE_AS</span>\n</code></pre>\n"}]}]},{"t":"heading","d":2,"p":{"lines":[150,151]},"v":"class HeapObjectData : public ObjectData","c":[{"t":"list_item","d":4,"p":{"lines":[151,152]},"v":"比 ObjectData 多了 <code>ObjectData* const map_;</code>"},{"t":"list_item","d":4,"p":{"lines":[152,153]},"v":"map_ 指针就位于父类 object_ 和 kind_ 的后面"},{"t":"list_item","d":4,"p":{"lines":[153,184]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/compiler/heap-refs.cc</span>\n<span class=\"token number\">154</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HeapObjectData</span> <span class=\"token operator\">:</span> <span class=\"token base-clause\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">ObjectData</span></span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">155</span>  <span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n<span class=\"token number\">156</span>   <span class=\"token function\">HeapObjectData</span><span class=\"token punctuation\">(</span>JSHeapBroker<span class=\"token operator\">*</span> broker<span class=\"token punctuation\">,</span> ObjectData<span class=\"token operator\">*</span><span class=\"token operator\">*</span> storage<span class=\"token punctuation\">,</span>\n<span class=\"token number\">157</span>                  Handle<span class=\"token operator\">&lt;</span>HeapObject<span class=\"token operator\">></span> object<span class=\"token punctuation\">,</span> ObjectDataKind kind<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">158</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">160</span>   ObjectData<span class=\"token operator\">*</span> <span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> map_<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token number\">161</span>   InstanceType <span class=\"token function\">GetMapInstanceType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">162</span>\n<span class=\"token number\">163</span>  <span class=\"token keyword\">private</span><span class=\"token operator\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">165</span>\n<span class=\"token number\">166</span>   ObjectData<span class=\"token operator\">*</span> <span class=\"token keyword\">const</span> map_<span class=\"token punctuation\">;</span>\n<span class=\"token number\">167</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">168</span>\n\n<span class=\"token comment\">// (gdb) whatis this</span>\n<span class=\"token comment\">// type = v8::internal::compiler::ObjectData *</span>\n<span class=\"token comment\">// (gdb) p this + 1</span>\n<span class=\"token comment\">// $28 = (v8::internal::compiler::ObjectData *) 0x555555780d10</span>\n<span class=\"token comment\">// (gdb) p &amp;(static_cast&lt;HeapObjectData*>(this)->map_)</span>\n<span class=\"token comment\">// $31 = (v8::internal::compiler::ObjectData * const *) 0x555555780d10</span>\n<span class=\"token comment\">// (gdb) p sizeof(HeapObjectData)</span>\n<span class=\"token comment\">// $30 = 32</span>\n<span class=\"token comment\">// (gdb) p sizeof(ObjectData)</span>\n<span class=\"token comment\">// $34 = 24</span>\n</code></pre>\n"},{"t":"list_item","d":4,"p":{"lines":[184,185]},"v":"HeapObjectData::GetMapInstanceType()","c":[{"t":"list_item","d":6,"p":{"lines":[185,196]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/compiler/heap-refs.cc</span>\n<span class=\"token number\">985</span> InstanceType <span class=\"token class-name\">HeapObjectData</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetMapInstanceType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">986</span>   ObjectData<span class=\"token operator\">*</span> map_data <span class=\"token operator\">=</span> <span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">987</span>   <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>map_data<span class=\"token operator\">-></span><span class=\"token function\">should_access_heap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">988</span>     <span class=\"token keyword\">return</span> <span class=\"token class-name\">Handle</span><span class=\"token operator\">&lt;</span>Map<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">cast</span><span class=\"token punctuation\">(</span>map_data<span class=\"token operator\">-></span><span class=\"token function\">object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">instance_type</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">989</span>   <span class=\"token punctuation\">}</span>\n<span class=\"token number\">990</span>   <span class=\"token keyword\">return</span> map_data<span class=\"token operator\">-></span><span class=\"token function\">AsMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">instance_type</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">991</span> <span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"t":"list_item","d":4,"p":{"lines":[196,197]},"v":"class MapData : public HeapObjectData","c":[{"t":"list_item","d":6,"p":{"lines":[197,198]},"v":"MapData 可以看作是 Map::ptr_ 指向的内存的对象化( 即 serialization )"},{"t":"list_item","d":6,"p":{"lines":[198,199]},"v":"在 ObjectData 和 HeapObjectData 的基础上，多了一系列 Map 的属性"},{"t":"list_item","d":6,"p":{"lines":[199,217]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/compiler/heap-refs.cc</span>\n<span class=\"token number\">644</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MapData</span> <span class=\"token operator\">:</span> <span class=\"token base-clause\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">HeapObjectData</span></span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">645</span>  <span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n<span class=\"token number\">646</span>   <span class=\"token function\">MapData</span><span class=\"token punctuation\">(</span>JSHeapBroker<span class=\"token operator\">*</span> broker<span class=\"token punctuation\">,</span> ObjectData<span class=\"token operator\">*</span><span class=\"token operator\">*</span> storage<span class=\"token punctuation\">,</span> Handle<span class=\"token operator\">&lt;</span>Map<span class=\"token operator\">></span> object<span class=\"token punctuation\">,</span>\n<span class=\"token number\">647</span>           ObjectDataKind kind<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">707</span>  <span class=\"token keyword\">private</span><span class=\"token operator\">:</span>\n<span class=\"token number\">712</span>   <span class=\"token comment\">// This block of fields will always be serialized.</span>\n<span class=\"token number\">713</span>   InstanceType instance_type_<span class=\"token punctuation\">;</span>\n<span class=\"token number\">714</span>   <span class=\"token keyword\">int</span> instance_size_<span class=\"token punctuation\">;</span>\n<span class=\"token number\">715</span>   <span class=\"token keyword\">uint32_t</span> bit_field3_<span class=\"token punctuation\">;</span>\n<span class=\"token number\">716</span>   <span class=\"token keyword\">int</span> unused_property_fields_<span class=\"token punctuation\">;</span>\n<span class=\"token number\">717</span>   <span class=\"token keyword\">bool</span> is_abandoned_prototype_map_<span class=\"token punctuation\">;</span>\n<span class=\"token number\">718</span>   <span class=\"token keyword\">int</span> in_object_properties_<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n</code></pre>\n"}]},{"t":"list_item","d":4,"p":{"lines":[217,218]},"v":"class PropertyCellData : public HeapObjectData","c":[{"t":"list_item","d":6,"p":{"lines":[218,219]},"v":"在 ObjectData 和 HeapObjectData 的基础上，多了 property_details_ 和 value_ 属性"},{"t":"list_item","d":6,"p":{"lines":[219,237]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">169</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PropertyCellData</span> <span class=\"token operator\">:</span> <span class=\"token base-clause\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">HeapObjectData</span></span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">170</span>  <span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">186</span>  <span class=\"token keyword\">private</span><span class=\"token operator\">:</span>\n<span class=\"token number\">187</span>   PropertyDetails property_details_ <span class=\"token operator\">=</span> <span class=\"token class-name\">PropertyDetails</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">188</span>   ObjectData<span class=\"token operator\">*</span> value_ <span class=\"token operator\">=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">189</span>\n<span class=\"token number\">190</span>   <span class=\"token keyword\">bool</span> <span class=\"token function\">serialized</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> value_ <span class=\"token operator\">!=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token number\">191</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// (gdb) ptype /m PropertyCellData</span>\n<span class=\"token comment\">// type = class PropertyCellData : public HeapObjectData {</span>\n<span class=\"token comment\">// private:</span>\n<span class=\"token comment\">//     PropertyDetails property_details_;</span>\n<span class=\"token comment\">//     ObjectData *value_;</span>\n<span class=\"token comment\">// }</span>\n</code></pre>\n"}]},{"t":"list_item","d":4,"p":{"lines":[237,238]},"v":"..."}]},{"t":"heading","d":2,"p":{"lines":[238,239]},"v":"class ObjectRef","c":[{"t":"list_item","d":4,"p":{"lines":[239,240]},"v":"对 ObjectData 和 JSHeapBroker 的封装"},{"t":"list_item","d":4,"p":{"lines":[240,257]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/compiler/heap-refs.h</span>\n<span class=\"token number\">221</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">V8_EXPORT_PRIVATE</span> ObjectRef <span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">228</span>   Handle<span class=\"token operator\">&lt;</span>Object<span class=\"token operator\">></span> <span class=\"token function\">object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">235</span> #define <span class=\"token function\">HEAP_IS_METHOD_DECL</span><span class=\"token punctuation\">(</span>Name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">bool</span> Is##<span class=\"token function\">Name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">239</span> #define <span class=\"token function\">HEAP_AS_METHOD_DECL</span><span class=\"token punctuation\">(</span>Name<span class=\"token punctuation\">)</span> Name##Ref As##<span class=\"token function\">Name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">268</span>   ObjectData<span class=\"token operator\">*</span> data_<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// Should be used only by object() getters.</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">283</span>   JSHeapBroker<span class=\"token operator\">*</span> broker_<span class=\"token punctuation\">;</span>\n<span class=\"token number\">284</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre>\n"},{"t":"list_item","d":4,"p":{"lines":[257,258]},"v":"ObjectRef::AsHeapObject &amp; IsHeapObject","c":[{"t":"list_item","d":6,"p":{"lines":[258,275]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">1501</span>   <span class=\"token keyword\">bool</span> <span class=\"token class-name\">ObjectRef</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">IsHeapObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">IsHeapObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n<span class=\"token number\">1502</span>   HeapObjectRef <span class=\"token class-name\">ObjectRef</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">AsHeapObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">1504</span>     <span class=\"token keyword\">return</span> <span class=\"token function\">HeapObjectRef</span><span class=\"token punctuation\">(</span><span class=\"token function\">broker</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">1505</span>   <span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 1500 #define DEFINE_IS_AND_AS(Name)                                    \\\n// 1501   bool ObjectRef::Is##Name() const { return data()->Is##Name(); } \\\n// 1502   Name##Ref ObjectRef::As##Name() const {                         \\\n// 1503     DCHECK(Is##Name());                                           \\\n// 1504     return Name##Ref(broker(), data());                           \\\n// 1505   }</span>\n<span class=\"token comment\">// 1506 HEAP_BROKER_OBJECT_LIST(DEFINE_IS_AND_AS)</span>\n<span class=\"token comment\">// 1507 #undef DEFINE_IS_AND_AS</span>\n</code></pre>\n"}]},{"t":"list_item","d":4,"p":{"lines":[275,276]},"v":"ObjectRef::object()","c":[{"t":"list_item","d":6,"p":{"lines":[276,283]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/compiler/heap-refs.cc</span>\n<span class=\"token number\">2660</span> Handle<span class=\"token operator\">&lt;</span>Object<span class=\"token operator\">></span> <span class=\"token class-name\">ObjectRef</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">2661</span>   <span class=\"token keyword\">return</span> data_<span class=\"token operator\">-></span><span class=\"token function\">object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">2662</span> <span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"t":"list_item","d":4,"p":{"lines":[283,284]},"v":"ObjectRef::data()","c":[{"t":"list_item","d":6,"p":{"lines":[284,300]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">2681</span> ObjectData<span class=\"token operator\">*</span> <span class=\"token class-name\">ObjectRef</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">2682</span>   <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span><span class=\"token function\">broker</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">mode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">2683</span>     <span class=\"token keyword\">case</span> JSHeapBroker<span class=\"token double-colon punctuation\">::</span>kDisabled<span class=\"token operator\">:</span>\n<span class=\"token number\">2684</span>       <span class=\"token keyword\">return</span> data_<span class=\"token punctuation\">;</span>\n<span class=\"token number\">2685</span>     <span class=\"token keyword\">case</span> JSHeapBroker<span class=\"token double-colon punctuation\">::</span>kSerializing<span class=\"token operator\">:</span>\n<span class=\"token number\">2686</span>       <span class=\"token function\">CHECK_NE</span><span class=\"token punctuation\">(</span>data_<span class=\"token operator\">-></span><span class=\"token function\">kind</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> kUnserializedHeapObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">2687</span>       <span class=\"token keyword\">return</span> data_<span class=\"token punctuation\">;</span>\n<span class=\"token number\">2688</span>     <span class=\"token keyword\">case</span> JSHeapBroker<span class=\"token double-colon punctuation\">::</span>kSerialized<span class=\"token operator\">:</span>\n<span class=\"token number\">2689</span>     <span class=\"token keyword\">case</span> JSHeapBroker<span class=\"token double-colon punctuation\">::</span>kRetired<span class=\"token operator\">:</span>\n<span class=\"token number\">2690</span>       <span class=\"token function\">CHECK_NE</span><span class=\"token punctuation\">(</span>data_<span class=\"token operator\">-></span><span class=\"token function\">kind</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> kUnserializedHeapObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">2691</span>       <span class=\"token keyword\">return</span> data_<span class=\"token punctuation\">;</span>\n<span class=\"token number\">2692</span>   <span class=\"token punctuation\">}</span>\n<span class=\"token number\">2693</span> <span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"t":"list_item","d":4,"p":{"lines":[300,301]},"v":"ObjectRef::broker()","c":[{"t":"list_item","d":6,"p":{"lines":[301,306]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">2679</span> JSHeapBroker<span class=\"token operator\">*</span> <span class=\"token class-name\">ObjectRef</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">broker</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> broker_<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"t":"list_item","d":4,"p":{"lines":[306,307]},"v":"ObjectRef::should_access_heap","c":[{"t":"list_item","d":6,"p":{"lines":[307,314]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">2376</span> <span class=\"token keyword\">bool</span> <span class=\"token class-name\">ObjectRef</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">should_access_heap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">2377</span>   <span class=\"token keyword\">return</span> <span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">should_access_heap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">2378</span> <span class=\"token punctuation\">}</span>\n</code></pre>\n"}]}]},{"t":"heading","d":2,"p":{"lines":[314,315]},"v":"class HeapObjectRef","c":[{"t":"list_item","d":4,"p":{"lines":[315,334]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/compiler/heap-refs.h</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">HeapObjectRef</span> <span class=\"token operator\">:</span> <span class=\"token base-clause\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">ObjectRef</span></span> <span class=\"token punctuation\">{</span>\n<span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n    <span class=\"token function\">DEFINE_REF_CONSTRUCTOR</span><span class=\"token punctuation\">(</span>HeapObject<span class=\"token punctuation\">,</span> ObjectRef<span class=\"token punctuation\">)</span>\n\n    Handle<span class=\"token operator\">&lt;</span>HeapObject<span class=\"token operator\">></span> <span class=\"token function\">object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>\n\n    MapRef <span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Only for use in special situations where we need to read the object's</span>\n    <span class=\"token comment\">// current map (instead of returning the cached map). Use with care.</span>\n    base<span class=\"token double-colon punctuation\">::</span>Optional<span class=\"token operator\">&lt;</span>MapRef<span class=\"token operator\">></span> <span class=\"token function\">map_direct_read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// See the comment on the HeapObjectType class.</span>\n    HeapObjectType <span class=\"token function\">GetHeapObjectType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre>\n"},{"t":"list_item","d":4,"p":{"lines":[334,335]},"v":"HeapObjectRef::map()","c":[{"t":"list_item","d":6,"p":{"lines":[335,346]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/compiler/heap-refs.cc</span>\n<span class=\"token comment\">// 1988 BIMODAL_ACCESSOR(HeapObject, Map, map)</span>\nMap <span class=\"token class-name\">HeapObjectRef</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>                \n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data_<span class=\"token operator\">-></span><span class=\"token function\">should_access_heap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> \n        <span class=\"token keyword\">return</span> <span class=\"token function\">object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>         \n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">ObjectRef</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">AsHeapObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]}]},{"t":"heading","d":2,"p":{"lines":[346,347]},"v":"Handle","c":[{"t":"bullet_list","d":3,"p":{"lines":[347,420]},"v":"","c":[{"t":"list_item","d":4,"p":{"lines":[347,348]},"v":"class HandleBase","c":[{"t":"list_item","d":6,"p":{"lines":[348,364]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/handles/handles.h</span>\n<span class=\"token number\">42</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HandleBase</span> <span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">55</span>   V8_INLINE Address <span class=\"token function\">address</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token generic-function\"><span class=\"token function\">bit_cast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Address<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>location_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">73</span>   <span class=\"token comment\">// This uses type Address* as opposed to a pointer type to a typed</span>\n<span class=\"token number\">74</span>   <span class=\"token comment\">// wrapper class, because it doesn't point to instances of such a</span>\n<span class=\"token number\">75</span>   <span class=\"token comment\">// wrapper class. Design overview: https://goo.gl/Ph4CGz</span>\n<span class=\"token number\">76</span>   Address<span class=\"token operator\">*</span> location_<span class=\"token punctuation\">;</span>\n<span class=\"token number\">77</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token number\">20</span> <span class=\"token class-name\">HandleBase</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">HandleBase</span><span class=\"token punctuation\">(</span>Address object<span class=\"token punctuation\">,</span> Isolate<span class=\"token operator\">*</span> isolate<span class=\"token punctuation\">)</span>\n<span class=\"token number\">21</span>     <span class=\"token operator\">:</span> <span class=\"token function\">location_</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HandleScope</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetHandle</span><span class=\"token punctuation\">(</span>isolate<span class=\"token punctuation\">,</span> object<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"t":"list_item","d":4,"p":{"lines":[364,365]},"v":"拿到一个 <code>Handle&lt;T&gt;</code> 只需要像 <code>T *</code> 一样使用就行了"},{"t":"list_item","d":4,"p":{"lines":[365,403]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">79</span> <span class=\"token comment\">// ----------------------------------------------------------------------------</span>\n<span class=\"token number\">80</span> <span class=\"token comment\">// A Handle provides a reference to an object that survives relocation by</span>\n<span class=\"token number\">81</span> <span class=\"token comment\">// the garbage collector.</span>\n<span class=\"token number\">82</span> <span class=\"token comment\">//</span>\n<span class=\"token number\">83</span> <span class=\"token comment\">// Handles are only valid within a HandleScope. When a handle is created</span>\n<span class=\"token number\">84</span> <span class=\"token comment\">// for an object a cell is allocated in the current HandleScope.</span>\n<span class=\"token number\">85</span> <span class=\"token comment\">//</span>\n<span class=\"token number\">86</span> <span class=\"token comment\">// Also note that Handles do not provide default equality comparison or hashing</span>\n<span class=\"token number\">87</span> <span class=\"token comment\">// operators on purpose. Such operators would be misleading, because intended</span>\n<span class=\"token number\">88</span> <span class=\"token comment\">// semantics is ambiguous between Handle location and object identity. Instead</span>\n<span class=\"token number\">89</span> <span class=\"token comment\">// use either {is_identical_to} or {location} explicitly.</span>\n<span class=\"token number\">90</span> <span class=\"token keyword\">template</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">typename</span> <span class=\"token class-name\">T</span><span class=\"token operator\">></span>\n<span class=\"token number\">91</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Handle</span> <span class=\"token keyword\">final</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">public</span> HandleBase <span class=\"token punctuation\">{</span>\n<span class=\"token number\">92</span>  <span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n<span class=\"token number\">93</span>   <span class=\"token comment\">// {ObjectRef} is returned by {Handle::operator->}. It should never be stored</span>\n<span class=\"token number\">94</span>   <span class=\"token comment\">// anywhere or used in any other code; no one should ever have to spell out</span>\n<span class=\"token number\">95</span>   <span class=\"token comment\">// {ObjectRef} in code. Its only purpose is to be dereferenced immediately by</span>\n<span class=\"token number\">96</span>   <span class=\"token comment\">// \"operator-> chaining\". Returning the address of the field is valid because</span>\n<span class=\"token number\">97</span>   <span class=\"token comment\">// this objects lifetime only ends at the end of the full statement.</span>\n<span class=\"token number\">98</span>   <span class=\"token keyword\">class</span> <span class=\"token class-name\">ObjectRef</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">99</span>    <span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n<span class=\"token number\">100</span>     T<span class=\"token operator\">*</span> <span class=\"token keyword\">operator</span><span class=\"token operator\">-></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token operator\">&amp;</span>object_<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token number\">101</span>\n<span class=\"token number\">102</span>    <span class=\"token keyword\">private</span><span class=\"token operator\">:</span>\n<span class=\"token number\">103</span>     <span class=\"token keyword\">friend</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Handle</span><span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">104</span>     <span class=\"token keyword\">explicit</span> <span class=\"token function\">ObjectRef</span><span class=\"token punctuation\">(</span>T object<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token function\">object_</span><span class=\"token punctuation\">(</span>object<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token number\">105</span>\n<span class=\"token number\">106</span>     T object_<span class=\"token punctuation\">;</span>\n<span class=\"token number\">107</span>   <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token number\">135</span>   V8_INLINE ObjectRef <span class=\"token keyword\">operator</span><span class=\"token operator\">-></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> ObjectRef<span class=\"token punctuation\">{</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token number\">136</span>\n<span class=\"token number\">137</span>   V8_INLINE T <span class=\"token keyword\">operator</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">141</span>     <span class=\"token keyword\">return</span> <span class=\"token class-name\">T</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">unchecked_cast</span><span class=\"token punctuation\">(</span><span class=\"token function\">Object</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token function\">location</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">142</span>   <span class=\"token punctuation\">}</span>\n</code></pre>\n"},{"t":"list_item","d":4,"p":{"lines":[403,404]},"v":"<code>Handle&lt;T&gt;::Handle()</code>"},{"t":"list_item","d":4,"p":{"lines":[410,411]},"v":"<code>Handle&lt;T&gt;::cast</code>","c":[{"t":"list_item","d":6,"p":{"lines":[411,420]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/handles/handles-inl.h</span>\n<span class=\"token number\">45</span> <span class=\"token keyword\">const</span> Handle<span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> <span class=\"token class-name\">Handle</span><span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">cast</span><span class=\"token punctuation\">(</span>Handle<span class=\"token operator\">&lt;</span>S<span class=\"token operator\">></span> that<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">46</span>   <span class=\"token class-name\">T</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">cast</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token function\">FullObjectSlot</span><span class=\"token punctuation\">(</span>that<span class=\"token punctuation\">.</span><span class=\"token function\">location</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">47</span>   <span class=\"token keyword\">return</span> <span class=\"token generic-function\"><span class=\"token function\">Handle</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>that<span class=\"token punctuation\">.</span>location_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">48</span> <span class=\"token punctuation\">}</span>\n</code></pre>\n"}]}]},{"t":"heading","d":3,"p":{"lines":[420,421]},"v":"HandleScope","c":[{"t":"list_item","d":5,"p":{"lines":[421,442]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// 179 Address* HandleScope::GetHandle(Isolate* isolate, Address value) {</span>\n<span class=\"token comment\">// 183   HandleScopeData* data = isolate->handle_scope_data();</span>\n<span class=\"token comment\">// 184   CanonicalHandleScope* canonical = data->canonical_scope;</span>\n<span class=\"token comment\">// 185   return canonical ? canonical->Lookup(value) : CreateHandle(isolate, value);</span>\n<span class=\"token comment\">// 186 }</span>\n\n<span class=\"token comment\">// 162 Address* HandleScope::CreateHandle(Isolate* isolate, Address value) {</span>\n<span class=\"token comment\">// 164   HandleScopeData* data = isolate->handle_scope_data();</span>\n<span class=\"token comment\">// 165   Address* result = data->next;</span>\n\n<span class=\"token comment\">// 169   // Update the current next field, set the value in the created handle,</span>\n<span class=\"token comment\">// 170   // and return the result.</span>\n<span class=\"token comment\">// 173   data->next = reinterpret_cast&lt;Address*>(reinterpret_cast&lt;Address>(result) +</span>\n<span class=\"token comment\">// 174                                           sizeof(Address));</span>\n<span class=\"token comment\">// 175   *result = value;</span>\n<span class=\"token comment\">// 176   return result;</span>\n<span class=\"token comment\">// 177 }</span>\n</code></pre>\n"}]},{"t":"heading","d":3,"p":{"lines":[442,443]},"v":"HandleScopeData","c":[{"t":"list_item","d":5,"p":{"lines":[443,459]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// 337 struct HandleScopeData final {</span>\n<span class=\"token comment\">// 338   Address* next;</span>\n<span class=\"token comment\">// 339   Address* limit;</span>\n<span class=\"token comment\">// 340   int level;</span>\n<span class=\"token comment\">// 341   int sealed_level;</span>\n<span class=\"token comment\">// 342   CanonicalHandleScope* canonical_scope;</span>\n<span class=\"token comment\">// 343</span>\n<span class=\"token comment\">// 344   void Initialize() {</span>\n<span class=\"token comment\">// 345     next = limit = nullptr;</span>\n<span class=\"token comment\">// 346     sealed_level = level = 0;</span>\n<span class=\"token comment\">// 347     canonical_scope = nullptr;</span>\n<span class=\"token comment\">// 348   }</span>\n<span class=\"token comment\">// 349 };</span>\n</code></pre>\n"}]}]}]})</script>
</body>
</html>
