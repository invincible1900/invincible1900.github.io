<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.25.0/themes/prism.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.2.0/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@6.7.0"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.2.7"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.2.0/dist/index.umd.min.js"></script><script>(r => {
                setTimeout(r);
              })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, data) => {
        const {
          Markmap
        } = getMarkmap();
        window.mm = Markmap.create('svg#mindmap', getOptions == null ? void 0 : getOptions(), data);
      })(() => window.markmap,null,{"t":"heading","d":1,"p":{"lines":[0,1]},"v":"Torque","c":[{"t":"heading","d":2,"p":{"lines":[1,2]},"v":"Torque","c":[{"t":"list_item","d":4,"p":{"lines":[2,3]},"v":"<a href=\"https://v8.dev/docs/torque\">V8 Torque user manual</a>"},{"t":"list_item","d":4,"p":{"lines":[3,4]},"v":"可以理解成一个自动生成 JS 对象的v8 实现的机制。"},{"t":"list_item","d":4,"p":{"lines":[4,5]},"v":"通过一套基本语法，自动生成目标代码，主要是用来表示一个JS 对象的在 v8 heap 中的内存分布情况。"},{"t":"list_item","d":4,"p":{"lines":[5,6]},"v":"jsobject, objcetmap, descriptorarry 等重要的类都是由这个类派生来的。"},{"t":"list_item","d":4,"p":{"lines":[6,7]},"v":"生成的类简单说就是 一个 pointer + 一堆 offset + 一堆取出 offset 内容的类方法"},{"t":"list_item","d":4,"p":{"lines":[7,8]},"v":"有一大堆基于 Torque 生成的 Object","c":[{"t":"list_item","d":6,"p":{"lines":[8,21]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/objects</span>\nls <span class=\"token operator\">*</span><span class=\"token punctuation\">.</span>tq\nallocation<span class=\"token operator\">-</span>site<span class=\"token punctuation\">.</span>tq  debug<span class=\"token operator\">-</span>objects<span class=\"token punctuation\">.</span>tq        heap<span class=\"token operator\">-</span>number<span class=\"token punctuation\">.</span>tq             js<span class=\"token operator\">-</span>collection<span class=\"token punctuation\">.</span>tq        js<span class=\"token operator\">-</span>objects<span class=\"token punctuation\">.</span>tq                 js<span class=\"token operator\">-</span>segment<span class=\"token operator\">-</span>iterator<span class=\"token punctuation\">.</span>tq  name<span class=\"token punctuation\">.</span>tq                        prototype<span class=\"token operator\">-</span>info<span class=\"token punctuation\">.</span>tq        <span class=\"token keyword\">struct</span><span class=\"token punctuation\">.</span>tq\napi<span class=\"token operator\">-</span>callbacks<span class=\"token punctuation\">.</span>tq    descriptor<span class=\"token operator\">-</span>array<span class=\"token punctuation\">.</span>tq     heap<span class=\"token operator\">-</span>object<span class=\"token punctuation\">.</span>tq             js<span class=\"token operator\">-</span>date<span class=\"token operator\">-</span>time<span class=\"token operator\">-</span>format<span class=\"token punctuation\">.</span>tq  js<span class=\"token operator\">-</span>plural<span class=\"token operator\">-</span>rules<span class=\"token punctuation\">.</span>tq            js<span class=\"token operator\">-</span>segments<span class=\"token punctuation\">.</span>tq          oddball<span class=\"token punctuation\">.</span>tq                     regexp<span class=\"token operator\">-</span>match<span class=\"token operator\">-</span>info<span class=\"token punctuation\">.</span>tq     swiss<span class=\"token operator\">-</span>hash<span class=\"token operator\">-</span>table<span class=\"token operator\">-</span>helpers<span class=\"token punctuation\">.</span>tq\narguments<span class=\"token punctuation\">.</span>tq        embedder<span class=\"token operator\">-</span>data<span class=\"token operator\">-</span>array<span class=\"token punctuation\">.</span>tq  intl<span class=\"token operator\">-</span>objects<span class=\"token punctuation\">.</span>tq            js<span class=\"token operator\">-</span>display<span class=\"token operator\">-</span>names<span class=\"token punctuation\">.</span>tq     js<span class=\"token operator\">-</span>promise<span class=\"token punctuation\">.</span>tq                 js<span class=\"token operator\">-</span>weak<span class=\"token operator\">-</span>refs<span class=\"token punctuation\">.</span>tq         ordered<span class=\"token operator\">-</span>hash<span class=\"token operator\">-</span>table<span class=\"token punctuation\">.</span>tq          scope<span class=\"token operator\">-</span>info<span class=\"token punctuation\">.</span>tq            swiss<span class=\"token operator\">-</span>name<span class=\"token operator\">-</span>dictionary<span class=\"token punctuation\">.</span>tq\nbigint<span class=\"token punctuation\">.</span>tq           feedback<span class=\"token operator\">-</span>cell<span class=\"token punctuation\">.</span>tq        js<span class=\"token operator\">-</span>array<span class=\"token operator\">-</span>buffer<span class=\"token punctuation\">.</span>tq         js<span class=\"token operator\">-</span>function<span class=\"token punctuation\">.</span>tq          js<span class=\"token operator\">-</span>proxy<span class=\"token punctuation\">.</span>tq                   literal<span class=\"token operator\">-</span>objects<span class=\"token punctuation\">.</span>tq      primitive<span class=\"token operator\">-</span>heap<span class=\"token operator\">-</span>object<span class=\"token punctuation\">.</span>tq       script<span class=\"token punctuation\">.</span>tq                synthetic<span class=\"token operator\">-</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span>tq\ncell<span class=\"token punctuation\">.</span>tq             feedback<span class=\"token operator\">-</span>vector<span class=\"token punctuation\">.</span>tq      js<span class=\"token operator\">-</span>array<span class=\"token punctuation\">.</span>tq                js<span class=\"token operator\">-</span>generator<span class=\"token punctuation\">.</span>tq         js<span class=\"token operator\">-</span>regexp<span class=\"token operator\">-</span>string<span class=\"token operator\">-</span>iterator<span class=\"token punctuation\">.</span>tq  map<span class=\"token punctuation\">.</span>tq                  promise<span class=\"token punctuation\">.</span>tq                     shared<span class=\"token operator\">-</span>function<span class=\"token operator\">-</span>info<span class=\"token punctuation\">.</span>tq  <span class=\"token keyword\">template</span><span class=\"token operator\">-</span>objects<span class=\"token punctuation\">.</span>tq\ncode<span class=\"token punctuation\">.</span>tq             fixed<span class=\"token operator\">-</span>array<span class=\"token punctuation\">.</span>tq          js<span class=\"token operator\">-</span><span class=\"token keyword\">break</span><span class=\"token operator\">-</span>iterator<span class=\"token punctuation\">.</span>tq       js<span class=\"token operator\">-</span>list<span class=\"token operator\">-</span>format<span class=\"token punctuation\">.</span>tq       js<span class=\"token operator\">-</span>regexp<span class=\"token punctuation\">.</span>tq                  megadom<span class=\"token operator\">-</span>handler<span class=\"token punctuation\">.</span>tq      property<span class=\"token operator\">-</span>array<span class=\"token punctuation\">.</span>tq              source<span class=\"token operator\">-</span>text<span class=\"token operator\">-</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span>tq    templates<span class=\"token punctuation\">.</span>tq\ncontexts<span class=\"token punctuation\">.</span>tq         foreign<span class=\"token punctuation\">.</span>tq              js<span class=\"token operator\">-</span>collator<span class=\"token punctuation\">.</span>tq             js<span class=\"token operator\">-</span>locale<span class=\"token punctuation\">.</span>tq            js<span class=\"token operator\">-</span>relative<span class=\"token operator\">-</span>time<span class=\"token operator\">-</span>format<span class=\"token punctuation\">.</span>tq    microtask<span class=\"token punctuation\">.</span>tq            property<span class=\"token operator\">-</span>cell<span class=\"token punctuation\">.</span>tq               stack<span class=\"token operator\">-</span>frame<span class=\"token operator\">-</span>info<span class=\"token punctuation\">.</span>tq      torque<span class=\"token operator\">-</span>defined<span class=\"token operator\">-</span>classes<span class=\"token punctuation\">.</span>tq\ndata<span class=\"token operator\">-</span>handler<span class=\"token punctuation\">.</span>tq     free<span class=\"token operator\">-</span>space<span class=\"token punctuation\">.</span>tq           js<span class=\"token operator\">-</span>collection<span class=\"token operator\">-</span>iterator<span class=\"token punctuation\">.</span>tq  js<span class=\"token operator\">-</span>number<span class=\"token operator\">-</span>format<span class=\"token punctuation\">.</span>tq     js<span class=\"token operator\">-</span>segmenter<span class=\"token punctuation\">.</span>tq               <span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span>tq               property<span class=\"token operator\">-</span>descriptor<span class=\"token operator\">-</span>object<span class=\"token punctuation\">.</span>tq  string<span class=\"token punctuation\">.</span>tq\n</code></pre>\n"}]},{"t":"list_item","d":4,"p":{"lines":[21,22]},"v":"macros","c":[{"t":"list_item","d":6,"p":{"lines":[22,23]},"v":"<code>src/objects/object-macros.h</code>"},{"t":"list_item","d":6,"p":{"lines":[23,24]},"v":"TQ_OBJECT_CONSTRUCTORS"},{"t":"list_item","d":6,"p":{"lines":[24,25]},"v":"DECL_GETTER"},{"t":"list_item","d":6,"p":{"lines":[25,26]},"v":"DECL_ACCESSORS"},{"t":"list_item","d":6,"p":{"lines":[26,27]},"v":"DEF_GETTER"},{"t":"list_item","d":6,"p":{"lines":[27,28]},"v":"ACCESSORS"}]}]},{"t":"heading","d":2,"p":{"lines":[29,30]},"v":"TaggedField","c":[{"t":"list_item","d":4,"p":{"lines":[30,31]},"v":"TaggedField是 Torque 类取数据的工具类"},{"t":"list_item","d":4,"p":{"lines":[31,32]},"v":"TaggedField 提供了load/set field 的方法"},{"t":"list_item","d":4,"p":{"lines":[32,33]},"v":"比如 load 方法简单来说就是：算基地址，算偏移(有的一级偏移，有的有二级偏移)，取内容(一般是半截指针)，把指针封装到对应的对象(在通过对象的方法去内容)"},{"t":"list_item","d":4,"p":{"lines":[33,53]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/objects/tagged-field.h</span>\n<span class=\"token keyword\">template</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">typename</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> kFieldOffset <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token operator\">></span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">TaggedField</span> <span class=\"token operator\">:</span> <span class=\"token base-clause\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">AllStatic</span></span> <span class=\"token punctuation\">{</span>\n<span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">inline</span> Address <span class=\"token function\">address</span><span class=\"token punctuation\">(</span>HeapObject host<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> offset <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">inline</span> T <span class=\"token function\">load</span><span class=\"token punctuation\">(</span>HeapObject host<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> offset <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">inline</span> T <span class=\"token function\">load</span><span class=\"token punctuation\">(</span>PtrComprCageBase cage_base<span class=\"token punctuation\">,</span> HeapObject host<span class=\"token punctuation\">,</span>\n                    <span class=\"token keyword\">int</span> offset <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">template</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">typename</span> <span class=\"token class-name\">TOnHeapAddress</span><span class=\"token operator\">></span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">inline</span> Address <span class=\"token function\">tagged_to_full</span><span class=\"token punctuation\">(</span>TOnHeapAddress on_heap_addr<span class=\"token punctuation\">,</span>\n                                    Tagged_t tagged_value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">inline</span> Tagged_t <span class=\"token function\">full_to_tagged</span><span class=\"token punctuation\">(</span>Address value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"},{"t":"list_item","d":4,"p":{"lines":[53,54]},"v":"TaggedField::load","c":[{"t":"list_item","d":6,"p":{"lines":[54,55]},"v":"通过偏移取出 tagged pointer，补充成 64 bit 地址，封装的 class T 实例中"},{"t":"list_item","d":6,"p":{"lines":[55,56]},"v":"偏移可以通过二级构成(kFieldOffset + offset)，一般 kFieldOffset 是第一级偏移，参数里面的 offset 是第二级"},{"t":"list_item","d":6,"p":{"lines":[56,57]},"v":"不指定的时候两个偏移都默认是 0"},{"t":"list_item","d":6,"p":{"lines":[57,58]},"v":"<code>return T( (host.ptr_ &amp; 0xffffffff00000000) + *(int *) (host.ptr_ - 1 + offset + kFieldOffset) )</code>"},{"t":"list_item","d":6,"p":{"lines":[58,59]},"v":"<code>return T( cage_base + *(int *) (host.ptr_ - 1 + offset + kFieldOffset) )</code>"},{"t":"list_item","d":6,"p":{"lines":[59,80]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/objects/tagged-field-inl.h</span>\n\n<span class=\"token number\">55</span> <span class=\"token comment\">// static</span>\n<span class=\"token number\">56</span> <span class=\"token keyword\">template</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">typename</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> kFieldOffset<span class=\"token operator\">></span>\n<span class=\"token number\">57</span> T <span class=\"token class-name\">TaggedField</span><span class=\"token operator\">&lt;</span>T<span class=\"token punctuation\">,</span> kFieldOffset<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>HeapObject host<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> offset<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">58</span>   Tagged_t value <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token function\">location</span><span class=\"token punctuation\">(</span>host<span class=\"token punctuation\">,</span> offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">59</span>   <span class=\"token function\">DCHECK_NE</span><span class=\"token punctuation\">(</span>kFieldOffset <span class=\"token operator\">+</span> offset<span class=\"token punctuation\">,</span> HeapObject<span class=\"token double-colon punctuation\">::</span>kMapOffset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">60</span>   <span class=\"token keyword\">return</span> <span class=\"token function\">T</span><span class=\"token punctuation\">(</span><span class=\"token function\">tagged_to_full</span><span class=\"token punctuation\">(</span>host<span class=\"token punctuation\">.</span><span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">61</span> <span class=\"token punctuation\">}</span>\n<span class=\"token number\">62</span>\n<span class=\"token number\">63</span> <span class=\"token comment\">// static</span>\n<span class=\"token number\">64</span> <span class=\"token keyword\">template</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">typename</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> kFieldOffset<span class=\"token operator\">></span>\n<span class=\"token number\">65</span> T <span class=\"token class-name\">TaggedField</span><span class=\"token operator\">&lt;</span>T<span class=\"token punctuation\">,</span> kFieldOffset<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>PtrComprCageBase cage_base<span class=\"token punctuation\">,</span>\n<span class=\"token number\">66</span>                                      HeapObject host<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> offset<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">67</span>   Tagged_t value <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token function\">location</span><span class=\"token punctuation\">(</span>host<span class=\"token punctuation\">,</span> offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">68</span>   <span class=\"token function\">DCHECK_NE</span><span class=\"token punctuation\">(</span>kFieldOffset <span class=\"token operator\">+</span> offset<span class=\"token punctuation\">,</span> HeapObject<span class=\"token double-colon punctuation\">::</span>kMapOffset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">69</span>   <span class=\"token keyword\">return</span> <span class=\"token function\">T</span><span class=\"token punctuation\">(</span><span class=\"token function\">tagged_to_full</span><span class=\"token punctuation\">(</span>cage_base<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">70</span> <span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"t":"list_item","d":4,"p":{"lines":[80,81]},"v":"TaggedField::tagged_to_full()","c":[{"t":"list_item","d":6,"p":{"lines":[81,82]},"v":"算 cage_base + value"},{"t":"list_item","d":6,"p":{"lines":[82,83]},"v":"kIsSmi: <code>return tagged_value</code>"},{"t":"list_item","d":6,"p":{"lines":[83,84]},"v":"<code>return (on_heap_addr &amp; 0xffffffff00000000) + tagged_value</code>"},{"t":"list_item","d":6,"p":{"lines":[84,153]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token number\">27</span> <span class=\"token comment\">// static</span>\n<span class=\"token number\">28</span> <span class=\"token keyword\">template</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">typename</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> kFieldOffset<span class=\"token operator\">></span>\n<span class=\"token number\">29</span> <span class=\"token keyword\">template</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">typename</span> <span class=\"token class-name\">TOnHeapAddress</span><span class=\"token operator\">></span>\n<span class=\"token number\">30</span> Address <span class=\"token class-name\">TaggedField</span><span class=\"token operator\">&lt;</span>T<span class=\"token punctuation\">,</span> kFieldOffset<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">tagged_to_full</span><span class=\"token punctuation\">(</span>\n<span class=\"token number\">31</span>     TOnHeapAddress on_heap_addr<span class=\"token punctuation\">,</span> Tagged_t tagged_value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">33</span>   <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>kIsSmi<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">34</span>     <span class=\"token keyword\">return</span> <span class=\"token function\">DecompressTaggedSigned</span><span class=\"token punctuation\">(</span>tagged_value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// smi 不需要cage_base ,直接取出 value</span>\n<span class=\"token number\">35</span>   <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>kIsHeapObject<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">36</span>     <span class=\"token keyword\">return</span> <span class=\"token function\">DecompressTaggedPointer</span><span class=\"token punctuation\">(</span>on_heap_addr<span class=\"token punctuation\">,</span> tagged_value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 0xffffffff00000000 mask 一下得到 cage_base</span>\n<span class=\"token number\">37</span>   <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">38</span>     <span class=\"token keyword\">return</span> <span class=\"token function\">DecompressTaggedAny</span><span class=\"token punctuation\">(</span>on_heap_addr<span class=\"token punctuation\">,</span> tagged_value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// 跟 HeapObject 一样</span>\n<span class=\"token number\">39</span>   <span class=\"token punctuation\">}</span>\n<span class=\"token number\">43</span> <span class=\"token punctuation\">}</span>\n</code></pre>\n","c":[{"t":"list_item","d":8,"p":{"lines":[100,153]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/common/ptr-compr-inl.h</span>\n<span class=\"token comment\">// Decompresses smi value.</span>\nV8_INLINE Address <span class=\"token function\">DecompressTaggedSigned</span><span class=\"token punctuation\">(</span>Tagged_t raw_value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// For runtime code the upper 32-bits of the Smi value do not matter.</span>\n    <span class=\"token keyword\">return</span> <span class=\"token generic-function\"><span class=\"token function\">static_cast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Address<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>raw_value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Decompresses weak or strong heap object pointer or forwarding pointer,</span>\n<span class=\"token comment\">// preserving both weak- and smi- tags.</span>\n<span class=\"token keyword\">template</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">typename</span> <span class=\"token class-name\">TOnHeapAddress</span><span class=\"token operator\">></span>\nV8_INLINE Address <span class=\"token function\">DecompressTaggedPointer</span><span class=\"token punctuation\">(</span>TOnHeapAddress on_heap_addr<span class=\"token punctuation\">,</span>\n                                        Tagged_t raw_value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token keyword\">return</span> <span class=\"token function\">GetPtrComprCageBaseAddress</span><span class=\"token punctuation\">(</span>on_heap_addr<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span>\n        <span class=\"token generic-function\"><span class=\"token function\">static_cast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Address<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>raw_value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Decompresses any tagged value, preserving both weak- and smi- tags.</span>\n<span class=\"token keyword\">template</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">typename</span> <span class=\"token class-name\">TOnHeapAddress</span><span class=\"token operator\">></span>\nV8_INLINE Address <span class=\"token function\">DecompressTaggedAny</span><span class=\"token punctuation\">(</span>TOnHeapAddress on_heap_addr<span class=\"token punctuation\">,</span>\n                                    Tagged_t raw_value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token keyword\">return</span> <span class=\"token function\">DecompressTaggedPointer</span><span class=\"token punctuation\">(</span>on_heap_addr<span class=\"token punctuation\">,</span> raw_value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n","c":[{"t":"list_item","d":10,"p":{"lines":[125,126]},"v":"GetPtrComprCageBaseAddress","c":[{"t":"list_item","d":12,"p":{"lines":[126,127]},"v":"<code>return (on_heap_addr &amp; 0xffffffff00000000)</code>"},{"t":"list_item","d":12,"p":{"lines":[127,137]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/common/ptr-compr-inl.h:36</span>\n<span class=\"token number\">36</span>  V8_INLINE <span class=\"token keyword\">constexpr</span> Address <span class=\"token function\">GetPtrComprCageBaseAddress</span><span class=\"token punctuation\">(</span>Address on_heap_addr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">37</span>    <span class=\"token keyword\">return</span> <span class=\"token generic-function\"><span class=\"token function\">RoundDown</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>kPtrComprCageBaseAlignment<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>on_heap_addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">38</span>  <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">(</span>gdb<span class=\"token punctuation\">)</span> p<span class=\"token operator\">/</span>x v8<span class=\"token double-colon punctuation\">::</span>internal<span class=\"token double-colon punctuation\">::</span>kPtrComprCageBaseAlignment\n$<span class=\"token number\">17</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x100000000</span>\n</code></pre>\n"},{"t":"list_item","d":12,"p":{"lines":[137,138]},"v":"RoundDown","c":[{"t":"list_item","d":14,"p":{"lines":[138,153]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\">#<span class=\"token number\">0</span>  <span class=\"token generic-function\"><span class=\"token function\">RoundDown</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token number\">4294967296l</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span><span class=\"token operator\">></span></span></span> <span class=\"token punctuation\">(</span>x<span class=\"token operator\">=</span><span class=\"token number\">52098087526681</span><span class=\"token punctuation\">)</span> at <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token operator\">/</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>src<span class=\"token operator\">/</span>base<span class=\"token operator\">/</span>macros<span class=\"token punctuation\">.</span>h<span class=\"token operator\">:</span><span class=\"token number\">331</span>\n<span class=\"token number\">331</span>   <span class=\"token keyword\">return</span> x <span class=\"token operator\">&amp;</span> <span class=\"token generic-function\"><span class=\"token function\">static_cast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// (gdb) disassemble</span>\n<span class=\"token comment\">// Dump of assembler code for function RoundDown&lt;4294967296l, unsigned long>(unsigned long):  // p/x 4294967296l: 0x100000000</span>\n<span class=\"token comment\">// => 0x00005555556545c0 &lt;+0>:  push   rbp</span>\n<span class=\"token comment\">//    0x00005555556545c1 &lt;+1>:  mov    rbp,rsp</span>\n<span class=\"token comment\">//    0x00005555556545c4 &lt;+4>:  mov    QWORD PTR [rbp-0x8],rdi  // i reg rdi: 0x2f6208002119, p/x on_heap_addr: 0x2f6208002119</span>\n<span class=\"token comment\">//    0x00005555556545c8 &lt;+8>:  movabs rax,0xffffffff00000000   // p/x -kPtrComprCageBaseAlignment:  0xffffffff00000000</span>\n<span class=\"token comment\">//    0x00005555556545d2 &lt;+18>: and    rax,QWORD PTR [rbp-0x8]</span>\n<span class=\"token comment\">//    0x00005555556545d6 &lt;+22>: pop    rbp</span>\n<span class=\"token comment\">//    0x00005555556545d7 &lt;+23>: ret</span>\n<span class=\"token comment\">// End of assembler dump.</span>\n</code></pre>\n"}]}]}]}]}]},{"t":"list_item","d":4,"p":{"lines":[153,154]},"v":"TaggedField::location() &amp; address()","c":[{"t":"list_item","d":6,"p":{"lines":[154,155]},"v":"<code>return host.ptr_ - kHeapObjectTag + kFieldOffset + offset</code>"},{"t":"list_item","d":6,"p":{"lines":[155,156]},"v":"address() 算地址，location() cast成指针"},{"t":"list_item","d":6,"p":{"lines":[156,176]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/objects/tagged-field-inl.h </span>\n<span class=\"token number\">21</span> <span class=\"token comment\">// static</span>\n<span class=\"token number\">22</span> <span class=\"token keyword\">template</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">typename</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> kFieldOffset<span class=\"token operator\">></span>\n<span class=\"token number\">23</span> Tagged_t<span class=\"token operator\">*</span> <span class=\"token class-name\">TaggedField</span><span class=\"token operator\">&lt;</span>T<span class=\"token punctuation\">,</span> kFieldOffset<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">location</span><span class=\"token punctuation\">(</span>HeapObject host<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> offset<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">24</span>   <span class=\"token keyword\">return</span> <span class=\"token generic-function\"><span class=\"token function\">reinterpret_cast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Tagged_t<span class=\"token operator\">*</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token function\">address</span><span class=\"token punctuation\">(</span>host<span class=\"token punctuation\">,</span> offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">25</span> <span class=\"token punctuation\">}</span>\n\n<span class=\"token number\">15</span> <span class=\"token comment\">// static</span>\n<span class=\"token number\">16</span> <span class=\"token keyword\">template</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">typename</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> kFieldOffset<span class=\"token operator\">></span>\n<span class=\"token number\">17</span> Address <span class=\"token class-name\">TaggedField</span><span class=\"token operator\">&lt;</span>T<span class=\"token punctuation\">,</span> kFieldOffset<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">address</span><span class=\"token punctuation\">(</span>HeapObject host<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> offset<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">18</span>   <span class=\"token keyword\">return</span> host<span class=\"token punctuation\">.</span><span class=\"token function\">address</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> kFieldOffset <span class=\"token operator\">+</span> offset<span class=\"token punctuation\">;</span>\n<span class=\"token number\">19</span> <span class=\"token punctuation\">}</span>\n<span class=\"token number\">20</span>\n\n<span class=\"token comment\">// HeapObject.address()</span>\n<span class=\"token comment\">// src/objects/heap-object.h:111</span>\n<span class=\"token keyword\">inline</span> Address <span class=\"token function\">address</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> kHeapObjectTag<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"t":"list_item","d":4,"p":{"lines":[176,177]},"v":"TaggedField::Relaxed_Load","c":[{"t":"list_item","d":6,"p":{"lines":[177,178]},"v":"多了个 Atomic ，其他跟 load 一样"},{"t":"list_item","d":6,"p":{"lines":[178,197]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/objects/tagged-field-inl.h</span>\n<span class=\"token number\">97</span>  <span class=\"token keyword\">template</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">typename</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> kFieldOffset<span class=\"token operator\">></span>\n<span class=\"token number\">98</span>  T <span class=\"token class-name\">TaggedField</span><span class=\"token operator\">&lt;</span>T<span class=\"token punctuation\">,</span> kFieldOffset<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Relaxed_Load</span><span class=\"token punctuation\">(</span>HeapObject host<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> offset<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">99</span>    AtomicTagged_t value <span class=\"token operator\">=</span> <span class=\"token class-name\">AsAtomicTagged</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Relaxed_Load</span><span class=\"token punctuation\">(</span><span class=\"token function\">location</span><span class=\"token punctuation\">(</span>host<span class=\"token punctuation\">,</span> offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">100</span>   <span class=\"token function\">DCHECK_NE</span><span class=\"token punctuation\">(</span>kFieldOffset <span class=\"token operator\">+</span> offset<span class=\"token punctuation\">,</span> HeapObject<span class=\"token double-colon punctuation\">::</span>kMapOffset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">101</span>   <span class=\"token keyword\">return</span> <span class=\"token function\">T</span><span class=\"token punctuation\">(</span><span class=\"token function\">tagged_to_full</span><span class=\"token punctuation\">(</span>host<span class=\"token punctuation\">.</span><span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">102</span> <span class=\"token punctuation\">}</span>\n\n\n<span class=\"token number\">105</span> <span class=\"token keyword\">template</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">typename</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> kFieldOffset<span class=\"token operator\">></span>\n<span class=\"token number\">106</span> T <span class=\"token class-name\">TaggedField</span><span class=\"token operator\">&lt;</span>T<span class=\"token punctuation\">,</span> kFieldOffset<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Relaxed_Load</span><span class=\"token punctuation\">(</span>PtrComprCageBase cage_base<span class=\"token punctuation\">,</span>\n<span class=\"token number\">107</span>                                              HeapObject host<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> offset<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">108</span>   AtomicTagged_t value <span class=\"token operator\">=</span> <span class=\"token class-name\">AsAtomicTagged</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Relaxed_Load</span><span class=\"token punctuation\">(</span><span class=\"token function\">location</span><span class=\"token punctuation\">(</span>host<span class=\"token punctuation\">,</span> offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">109</span>   <span class=\"token function\">DCHECK_NE</span><span class=\"token punctuation\">(</span>kFieldOffset <span class=\"token operator\">+</span> offset<span class=\"token punctuation\">,</span> HeapObject<span class=\"token double-colon punctuation\">::</span>kMapOffset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">110</span>   <span class=\"token keyword\">return</span> <span class=\"token function\">T</span><span class=\"token punctuation\">(</span><span class=\"token function\">tagged_to_full</span><span class=\"token punctuation\">(</span>cage_base<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">111</span> <span class=\"token punctuation\">}</span>\n</code></pre>\n"}]}]},{"t":"heading","d":2,"p":{"lines":[197,198]},"v":"TorqueGeneratedPropertyCell","c":[{"t":"list_item","d":4,"p":{"lines":[198,199]},"v":"class PropertyCell","c":[{"t":"list_item","d":6,"p":{"lines":[199,200]},"v":"这个类代表的是JS Global Property( <code>var o = {a: 1}</code> )，包含了 name(<code>a</code>)，value(<code>{a:1}</code>)"},{"t":"list_item","d":6,"p":{"lines":[200,201]},"v":"PropertyCell 可以认为是给 TorqueGeneratedPropertyCell 套的一个壳，其他的类也都是这个情况"},{"t":"list_item","d":6,"p":{"lines":[201,255]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/objects/property-cell.h</span>\n<span class=\"token number\">19</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PropertyCell</span>\n<span class=\"token number\">20</span>     <span class=\"token operator\">:</span> <span class=\"token keyword\">public</span> TorqueGeneratedPropertyCell<span class=\"token operator\">&lt;</span>PropertyCell<span class=\"token punctuation\">,</span> HeapObject<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">22</span>   <span class=\"token comment\">// [name]: the name of the global property.</span>\n<span class=\"token number\">23</span>   <span class=\"token function\">DECL_GETTER</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> Name<span class=\"token punctuation\">)</span>\n<span class=\"token number\">25</span>   <span class=\"token comment\">// [property_details]: details of the global property.</span>\n<span class=\"token number\">26</span>   <span class=\"token function\">DECL_GETTER</span><span class=\"token punctuation\">(</span>property_details_raw<span class=\"token punctuation\">,</span> Smi<span class=\"token punctuation\">)</span>\n<span class=\"token number\">32</span>   <span class=\"token comment\">// [value]: value of the global property.</span>\n<span class=\"token number\">33</span>   <span class=\"token function\">DECL_GETTER</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span> Object<span class=\"token punctuation\">)</span>\n<span class=\"token number\">36</span>   <span class=\"token comment\">// [dependent_code]: code that depends on the type of the global property.</span>\n<span class=\"token number\">37</span>   <span class=\"token function\">DECL_ACCESSORS</span><span class=\"token punctuation\">(</span>dependent_code<span class=\"token punctuation\">,</span> DependentCode<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">47</span>   <span class=\"token comment\">// Computes the new type of the cell's contents for the given value, but</span>\n<span class=\"token number\">48</span>   <span class=\"token comment\">// without actually modifying the details.</span>\n<span class=\"token number\">49</span>   <span class=\"token keyword\">static</span> PropertyCellType <span class=\"token function\">UpdatedType</span><span class=\"token punctuation\">(</span>Isolate<span class=\"token operator\">*</span> isolate<span class=\"token punctuation\">,</span>\n<span class=\"token number\">50</span>                                       Handle<span class=\"token operator\">&lt;</span>PropertyCell<span class=\"token operator\">></span> cell<span class=\"token punctuation\">,</span>\n<span class=\"token number\">51</span>                                       Handle<span class=\"token operator\">&lt;</span>Object<span class=\"token operator\">></span> value<span class=\"token punctuation\">,</span>\n<span class=\"token number\">52</span>                                       PropertyDetails details<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">92</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre>\n","c":[{"t":"list_item","d":8,"p":{"lines":[224,225]},"v":"PropertyCell::value()","c":[{"t":"list_item","d":10,"p":{"lines":[225,238]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// 28 ACCESSORS(PropertyCell, value, Object, kValueOffset)</span>\n<span class=\"token comment\">// 187   DEF_GETTER(PropertyCell, value, Object) {         </span>\nObject <span class=\"token class-name\">PropertyCell</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">value</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n    PtrComprCageBase cage_base <span class=\"token operator\">=</span> <span class=\"token function\">GetPtrComprCageBase</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">PropertyCell</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">value</span><span class=\"token punctuation\">(</span>cage_base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\nObject <span class=\"token class-name\">PropertyCell</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">value</span><span class=\"token punctuation\">(</span>PtrComprCageBase cage_base<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span>\n    Object value <span class=\"token operator\">=</span> <span class=\"token class-name\">TaggedField</span><span class=\"token operator\">&lt;</span>Object<span class=\"token punctuation\">,</span> kValueOffset<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>cage_base<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> value<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>                                                               \n</code></pre>\n"}]},{"t":"list_item","d":8,"p":{"lines":[238,239]},"v":"PropertyCell::property_details()","c":[{"t":"list_item","d":10,"p":{"lines":[239,255]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">//  25 ACCESSORS(PropertyCell, property_details_raw, Smi, kPropertyDetailsRawOffset)</span>\n<span class=\"token number\">31</span> PropertyDetails <span class=\"token class-name\">PropertyCell</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">property_details</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n<span class=\"token number\">32</span>   <span class=\"token keyword\">return</span> <span class=\"token function\">PropertyDetails</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Smi</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">cast</span><span class=\"token punctuation\">(</span><span class=\"token function\">property_details_raw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token number\">33</span> <span class=\"token punctuation\">}</span>\n\nSmi <span class=\"token class-name\">PropertyCell</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">property_details_raw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n    PtrComprCageBase cage_base <span class=\"token operator\">=</span> <span class=\"token function\">GetPtrComprCageBase</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">PropertyCell</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">property_details_raw</span><span class=\"token punctuation\">(</span>cage_base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\nSmi <span class=\"token class-name\">PropertyCell</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">property_details_raw</span><span class=\"token punctuation\">(</span>PtrComprCageBase cage_base<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span>\n    Smi property_details_raw <span class=\"token operator\">=</span> <span class=\"token class-name\">TaggedField</span><span class=\"token operator\">&lt;</span>Smi<span class=\"token punctuation\">,</span> kPropertyDetailsRawOffset<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>cage_base<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> property_details_raw<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]}]}]},{"t":"list_item","d":4,"p":{"lines":[255,256]},"v":"class TorqueGeneratedPropertyCell","c":[{"t":"list_item","d":6,"p":{"lines":[256,257]},"v":"一个指针 + 一堆 FieldOffset"},{"t":"list_item","d":6,"p":{"lines":[257,326]},"v":"<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// src/objects/property-cell.tq</span>\n<span class=\"token comment\">// Torque 格式写的\"模版\"</span>\n<span class=\"token number\">5</span> <span class=\"token keyword\">extern</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PropertyCell</span> extends HeapObject <span class=\"token punctuation\">{</span>\n<span class=\"token number\">6</span>   name<span class=\"token operator\">:</span> AnyName<span class=\"token punctuation\">;</span>\n<span class=\"token number\">7</span>   property_details_raw<span class=\"token operator\">:</span> Smi<span class=\"token punctuation\">;</span>\n<span class=\"token number\">8</span>   value<span class=\"token operator\">:</span> Object<span class=\"token punctuation\">;</span>\n<span class=\"token number\">9</span>   dependent_code<span class=\"token operator\">:</span> DependentCode<span class=\"token punctuation\">;</span>\n<span class=\"token number\">10</span> <span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 根据模版生成的类</span>\n<span class=\"token comment\">// out/Debug/gen/v8/torque-generated/src/objects/property-cell-tq-.inc</span>\n<span class=\"token comment\">// TorqueGeneratedPropertyCell&lt;PropertyCell, HeapObject></span>\n<span class=\"token keyword\">template</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">class</span> <span class=\"token class-name\">D</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">P</span><span class=\"token operator\">></span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">TorqueGeneratedPropertyCell</span> <span class=\"token operator\">:</span> <span class=\"token base-clause\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">P</span></span> <span class=\"token punctuation\">{</span>\n<span class=\"token keyword\">inline</span> Name <span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">inline</span> <span class=\"token keyword\">int</span> <span class=\"token function\">property_details_raw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">inline</span> Object <span class=\"token function\">value</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token comment\">// e.g: TorqueGeneratedPropertyCell&lt;PropertyCell, HeapObject></span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">constexpr</span> <span class=\"token keyword\">int</span> kStartOfStrongFieldsOffset <span class=\"token operator\">=</span> P<span class=\"token double-colon punctuation\">::</span>kHeaderSize<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// p HeapObject::kHeaderSize: 4</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">constexpr</span> <span class=\"token keyword\">int</span> kNameOffset <span class=\"token operator\">=</span> P<span class=\"token double-colon punctuation\">::</span>kHeaderSize<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 4</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">constexpr</span> <span class=\"token keyword\">int</span> kNameOffsetEnd <span class=\"token operator\">=</span> kNameOffset <span class=\"token operator\">+</span> kTaggedSize <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 7</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">constexpr</span> <span class=\"token keyword\">int</span> kPropertyDetailsRawOffset <span class=\"token operator\">=</span> kNameOffsetEnd <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 8</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">constexpr</span> <span class=\"token keyword\">int</span> kPropertyDetailsRawOffsetEnd <span class=\"token operator\">=</span> kPropertyDetailsRawOffset <span class=\"token operator\">+</span> kTaggedSize <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 11</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">constexpr</span> <span class=\"token keyword\">int</span> kValueOffset <span class=\"token operator\">=</span> kPropertyDetailsRawOffsetEnd <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 12</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">constexpr</span> <span class=\"token keyword\">int</span> kValueOffsetEnd <span class=\"token operator\">=</span> kValueOffset <span class=\"token operator\">+</span> kTaggedSize <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 15</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">constexpr</span> <span class=\"token keyword\">int</span> kDependentCodeOffset <span class=\"token operator\">=</span> kValueOffsetEnd <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 16</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">constexpr</span> <span class=\"token keyword\">int</span> kDependentCodeOffsetEnd <span class=\"token operator\">=</span> kDependentCodeOffset <span class=\"token operator\">+</span> kTaggedSize <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 19</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">constexpr</span> <span class=\"token keyword\">int</span> kEndOfStrongFieldsOffset <span class=\"token operator\">=</span> kDependentCodeOffsetEnd <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 20</span>\n\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">constexpr</span> <span class=\"token keyword\">int</span> kStartOfWeakFieldsOffset <span class=\"token operator\">=</span> kDependentCodeOffsetEnd <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 20</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">constexpr</span> <span class=\"token keyword\">int</span> kEndOfWeakFieldsOffset <span class=\"token operator\">=</span> kDependentCodeOffsetEnd <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 20</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">constexpr</span> <span class=\"token keyword\">int</span> kHeaderSize <span class=\"token operator\">=</span> kDependentCodeOffsetEnd <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 20</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">constexpr</span> <span class=\"token keyword\">int</span> kSize <span class=\"token operator\">=</span> kDependentCodeOffsetEnd <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 20</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// out/Debug/gen/v8/torque-generated/src/objects/property-cell-tq-inl.inc</span>\n<span class=\"token keyword\">template</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">class</span> <span class=\"token class-name\">D</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">P</span><span class=\"token operator\">></span>\nName <span class=\"token class-name\">TorqueGeneratedPropertyCell</span><span class=\"token operator\">&lt;</span>D<span class=\"token punctuation\">,</span> P<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span>PtrComprCageBase cage_base<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n    Name value<span class=\"token punctuation\">;</span>\n    value <span class=\"token operator\">=</span> <span class=\"token class-name\">TaggedField</span><span class=\"token operator\">&lt;</span>Name<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>cage_base<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> kNameOffset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> value<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">template</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">class</span> <span class=\"token class-name\">D</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">P</span><span class=\"token operator\">></span>\n<span class=\"token keyword\">int</span> <span class=\"token class-name\">TorqueGeneratedPropertyCell</span><span class=\"token operator\">&lt;</span>D<span class=\"token punctuation\">,</span> P<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">property_details_raw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> value<span class=\"token punctuation\">;</span>\n    value <span class=\"token operator\">=</span> <span class=\"token class-name\">TaggedField</span><span class=\"token operator\">&lt;</span>Smi<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> kPropertyDetailsRawOffset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">value</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> value<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">template</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">class</span> <span class=\"token class-name\">D</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">P</span><span class=\"token operator\">></span>\nObject <span class=\"token class-name\">TorqueGeneratedPropertyCell</span><span class=\"token operator\">&lt;</span>D<span class=\"token punctuation\">,</span> P<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">value</span><span class=\"token punctuation\">(</span>PtrComprCageBase cage_base<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n    Object value<span class=\"token punctuation\">;</span>\n    value <span class=\"token operator\">=</span> <span class=\"token class-name\">TaggedField</span><span class=\"token operator\">&lt;</span>Object<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>cage_base<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> kValueOffset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> value<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]}]},{"t":"heading","d":2,"p":{"lines":[326,327]},"v":"TorqueGeneratedDescriptorArray","c":[{"t":"list_item","d":4,"p":{"lines":[327,328]},"v":"<code>src/objects/descriptor-array.h</code>"}]},{"t":"heading","d":2,"p":{"lines":[328,329]},"v":"TorqueGeneratedJSObject","c":[{"t":"list_item","d":4,"p":{"lines":[329,330]},"v":"<code>src/objects/js-objects.h</code>"}]},{"t":"heading","d":2,"p":{"lines":[330,331]},"v":"TorqueGeneratedMap","c":[{"t":"list_item","d":4,"p":{"lines":[331,332]},"v":"<code>src/objects/map.h</code>"}]}]})</script>
</body>
</html>
